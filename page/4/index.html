<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="_85tctgPWrqH2EPVuuD5IT6KE-tW8nH0hTISJDMnShg">
  <meta name="baidu-site-verification" content="bb16c5b1fd3302c18e0015bef11eea42">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ggaaooppeenngg.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"onmobile":false},"hljswrap":true,"copycode":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="为什么计算机科学是无限的但生命是有限的">
<meta property="og:type" content="website">
<meta property="og:title" content="ggaaooppeenngg">
<meta property="og:url" content="https://ggaaooppeenngg.github.io/page/4/index.html">
<meta property="og:site_name" content="ggaaooppeenngg">
<meta property="og:description" content="为什么计算机科学是无限的但生命是有限的">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ggaaooppeenngg">
<meta property="article:tag" content="ggaaooppeenngg,kernel,sysml,golang,python,rust">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ggaaooppeenngg.github.io/page/4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ggaaooppeenngg</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62096626-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-62096626-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?bb16c5b1fd3302c18e0015bef11eea42"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ggaaooppeenngg</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">为什么计算机科学是无限的但生命是有限的</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">135</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">14</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">79</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ggaaooppeenngg</p>
  <div class="site-description" itemprop="description">为什么计算机科学是无限的但生命是有限的</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">135</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ggaaooppeenngg" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ggaaooppeenngg" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:peng.gao.dut@gmail.com" title="E-Mail → mailto:peng.gao.dut@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2019/03/03/tf-%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BF%9D%E5%AD%98%E5%92%8C%E5%86%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2019/03/03/tf-%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BF%9D%E5%AD%98%E5%92%8C%E5%86%BB%E7%BB%93/" class="post-title-link" itemprop="url">tensorflow 模型的存档、保存、冻结、优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-03 02:29:46" itemprop="dateCreated datePublished" datetime="2019-03-03T02:29:46+08:00">2019-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2019/03/03/tf-%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BF%9D%E5%AD%98%E5%92%8C%E5%86%BB%E7%BB%93/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2019/03/03/tf-模型的保存和冻结/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>模型的保存分三种类型</p>
<ol>
<li> 知道模型结构，单纯保存变量</li>
<li> 不知道模型结构，保存模型和变量</li>
<li> 不需要再改变量，只要常量化的模型（“冻结”）</li>
</ol>
<p>第一种用于训练的存档，并且临时恢复，这个时候用户是把训练需要的网络结构在代码里面构造好了的，只是在一定的时间下需要暂时保存网络中的变量，为了在崩溃之后继续训练。所以自然而然会有一个问题，如果我用 Python 写的代码，需要在 C++ 当中恢复，我需要知道你的模型结构，才能恢复，这个最蠢的办法是用 C++ 把你的网络结构再构造一遍，但我们按照统一的协议（比如 Protobuf）确定网络结构，就可以直接从标准序列化的数据中解析网络结构，这就是第二种情况，独立于语言，模型和变量一起保存的情况。然后如果碰到我们不需要再训练了，比如只是把这个模型进行部署，不需要改变相关的变量，那么其实只要一个带常量的模型就可以，这就是第三种情况，把变量冻结的正向传播模型。接下来会依次解释这几种情况的工作方式。</p>
<p>除了这些以外，针对用于服务的模型还可以做很多的优化。</p>
<h2 id="存档"><a href="#存档" class="headerlink" title="存档"></a>存档</h2><p>存档只是单纯的保存变量，并且能够恢复，可以在一定的迭代次数以后保存变量，并且从任意一个存档开始重新训练。以两个变量加减 1 为例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import tensorflow as tf</span><br><span class="line"></span><br><span class="line"># Create some variables.</span><br><span class="line">v1 = tf.get_variable(&quot;v1&quot;, shape=[3], initializer = tf.zeros_initializer)</span><br><span class="line">v2 = tf.get_variable(&quot;v2&quot;, shape=[5], initializer = tf.zeros_initializer)</span><br><span class="line"></span><br><span class="line">inc_v1 = v1.assign(v1+1)</span><br><span class="line">dec_v2 = v2.assign(v2-1)</span><br><span class="line"></span><br><span class="line"># Add an op to initialize the variables.</span><br><span class="line">init_op = tf.global_variables_initializer()</span><br><span class="line"></span><br><span class="line"># Add ops to save and restore all the variables.</span><br><span class="line">saver = tf.train.Saver()</span><br><span class="line"></span><br><span class="line"># Later, launch the model, initialize the variables, do some work, and save the</span><br><span class="line"># variables to disk.</span><br><span class="line">with tf.Session() as sess:</span><br><span class="line">  sess.run(init_op)</span><br><span class="line">  # Do some work with the model.</span><br><span class="line">  inc_v1.op.run()</span><br><span class="line">  dec_v2.op.run()</span><br><span class="line">  # Save the variables to disk.</span><br><span class="line">  save_path = saver.save(sess, &quot;/tmp/tf-test/model.ckpt&quot;)</span><br><span class="line">  print(&quot;Model saved in path: %s&quot; % save_path)</span><br></pre></td></tr></table></figure>

<p>可以在 <code>/tmp/tf-test</code> 下面看到这几个文件 <code>checkpoint                     model.ckpt.data-00000-of-00001 model.ckpt.index               model.ckpt.meta</code>。</p>
<p>可以通过脚本观察保存的变量 <code>python  $tensorflow-src/tensorflow/python/tools/inspect_checkpoint.py --file_name=/tmp/tf-test/model.ckpt  --all_tensors</code></p>
<p>得到保存的变量的内容，注意 <code>model.ckpt</code> 这个只是文件前缀。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tensor_name:  v1</span><br><span class="line">[1. 1. 1.]</span><br><span class="line">tensor_name:  v2</span><br><span class="line">[-1. -1. -1. -1. -1.]</span><br></pre></td></tr></table></figure>
<p>如果要恢复的话，可以通过下面的代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import tensorflow as tf</span><br><span class="line"></span><br><span class="line"># Create some variables.</span><br><span class="line">v1 = tf.get_variable(&quot;v1&quot;, shape=[3])</span><br><span class="line">v2 = tf.get_variable(&quot;v2&quot;, shape=[5])</span><br><span class="line"></span><br><span class="line"># Add ops to save and restore all the variables.</span><br><span class="line">saver = tf.train.Saver()</span><br><span class="line"></span><br><span class="line"># Later, launch the model, use the saver to restore variables from disk, and</span><br><span class="line"># do some work with the model.</span><br><span class="line">with tf.Session() as sess:</span><br><span class="line">  # Restore variables from disk.</span><br><span class="line">  saver.restore(sess, &quot;/tmp/tf-test/model.ckpt&quot;)</span><br><span class="line">  print(&quot;Model restored.&quot;)</span><br><span class="line">  # Check the values of the variables</span><br><span class="line">  print(&quot;v1 : %s&quot; % v1.eval())</span><br><span class="line">  print(&quot;v2 : %s&quot; % v2.eval())</span><br></pre></td></tr></table></figure>
<p>得到一样的效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v1 : [1. 1. 1.]</span><br><span class="line">v2 : [-1. -1. -1. -1. -1.]</span><br></pre></td></tr></table></figure>
<p>具体来说 .meta 对应的是 MetaGraph 和 SaverGraph，.index 对应的是变量值的位置，key 是变量名，value 是变量保存的入口定义，data 变量的值具体保存的文件。这是恢复代码中已经原样构造出了 Graph，如果没有构造的化，需要通过 <code>tf.train.import_meta_graph(&#39;/tmp/model.ckpt.meta&#39;)</code> 来加载，但是存档保存的信息比较单一，Tensorflow 提供了一个更丰富的 API 来使用。</p>
<h2 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h2><p><code>SavedModelBuilder</code> 保存的 API 比较丰富，能够保存多个 MetaGraph 和 Variables 的组合，除此之外还能附带 assets，并且要指定模型签名，<code>simple_saved</code> 的方法是一个简单版本的调用，适用于 Predict API。这里要展开一下 GraphDef, MetaGraphDef, SignatureDef, tags 这些东西的概念。对于 MetaGraph，<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38542085/article/details/78554550">这篇文章</a>解释得很清楚。SignatureDef 是对应了一种图的输入和输出，可以依据这个进行 serving API 的调用，类似于函数签名，相对于一个接口的定义。</p>
<p>tensorflow_serving 自己给了个<a target="_blank" rel="noopener" href="https://github.com/tensorflow/serving/blob/master/tensorflow_serving/example/mnist_saved_model.py">例子</a>，执行 <code>python mnist_saved_model.py /tmp/tf-test-2</code> 以后可以获得一个目录，下面有版本 1 的模型数据，执行 <code>saved_model_cli show --dir  /tmp/tf-test-2/1</code> 可以查看对应的签名。可以看到对应的层级关系，默认用于服务的模型会打上 serve 的标签，函数签名有两个，分别对应了 predict 和 classify 的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">MetaGraphDef with tag-set: &#x27;serve&#x27; contains the following SignatureDefs:</span><br><span class="line"></span><br><span class="line">signature_def[&#x27;predict_images&#x27;]:</span><br><span class="line">  The given SavedModel SignatureDef contains the following input(s):</span><br><span class="line">    inputs[&#x27;images&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: (-1, 784)</span><br><span class="line">        name: x:0</span><br><span class="line">  The given SavedModel SignatureDef contains the following output(s):</span><br><span class="line">    outputs[&#x27;scores&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: (-1, 10)</span><br><span class="line">        name: y:0</span><br><span class="line">  Method name is: tensorflow/serving/predict</span><br><span class="line"></span><br><span class="line">signature_def[&#x27;serving_default&#x27;]:</span><br><span class="line">  The given SavedModel SignatureDef contains the following input(s):</span><br><span class="line">    inputs[&#x27;inputs&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_STRING</span><br><span class="line">        shape: unknown_rank</span><br><span class="line">        name: tf_example:0</span><br><span class="line">  The given SavedModel SignatureDef contains the following output(s):</span><br><span class="line">    outputs[&#x27;classes&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_STRING</span><br><span class="line">        shape: (-1, 10)</span><br><span class="line">        name: index_to_string_Lookup:0</span><br><span class="line">    outputs[&#x27;scores&#x27;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: (-1, 10)</span><br><span class="line">        name: TopKV2:0</span><br><span class="line">  Method name is: tensorflow/serving/classify</span><br></pre></td></tr></table></figure>
<p>可以参考 tensorflow 的 <a target="_blank" rel="noopener" href="https://www.tensorflow.org/tfx/serving/api_rest">REST API</a>，比如 <code>GET http://host:port/v1/models/$&#123;MODEL_NAME&#125;[/versions/$&#123;MODEL_VERSION&#125;]</code> 其实对应这个例子就是 <code>GET http://host:port/v1/models/tf-test-2/versions/1</code>，然后感觉函数签名不同的 method name，可以调用不同的 request，比如 <code>POST http://host:port/v1/models/$&#123;MODEL_NAME&#125;[/versions/$&#123;MODEL_VERSION&#125;]:predict</code> 这个格式，如果输入和输出对应的是 <code>images</code> 和 <code>scores</code> 那么就对应了第一个签名。</p>
<h2 id="冻结"><a href="#冻结" class="headerlink" title="冻结"></a>冻结</h2><p>冻结的情况就是变量不再需要修改，直接把变量转化成常量保存成单一的模型，方便在部署的场景下使用。<br>冻结模型的代码在<a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/tools/freeze_graph.py">这里</a>，他的主要流程如下</p>
<ol>
<li>清除所有 Op 中的 device，让原来在指定 CPU/GPU/节点 上的 Op 不再绑定。</li>
<li>通过 <code>graph_util.convert_variables_to_constants</code> 将所有的 Variable <code>eval</code> 一次，把变量的 Op 的结果拿到，替换成 constant</li>
</ol>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>除了冻结模型以外，还可以删减一些多余的节点，比如 Summary 节点或者 Identity 节点，甚者把 16bit 的浮点数权重修改为 8bit 的浮点数权重（这个在 Tensorflow Lite 里很有用）。<a target="_blank" rel="noopener" href="https://medium.com/google-cloud/optimizing-tensorflow-models-for-serving-959080e9ddbf">这篇文章</a> 列出了详细的优化方式，主要是靠 <code>transform_graph</code> 这个工具，地址在<a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/tools/graph_transforms/README.md">这</a>，他有很详细的柴剪列表，并且可以自己编写裁剪函数，充分做到模型在部署环节的“纯净化”，调用方式也很简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">transform_graph \</span><br><span class="line">--in_graph=tensorflow_inception_graph.pb \</span><br><span class="line">--out_graph=optimized_inception_graph.pb \</span><br><span class="line">--inputs=&#x27;Mul:0&#x27; \</span><br><span class="line">--outputs=&#x27;softmax:0&#x27; \</span><br><span class="line">--transforms=&#x27;</span><br><span class="line">strip_unused_nodes(type=float, shape=&quot;1,299,299,3&quot;)</span><br><span class="line">remove_nodes(op=Identity, op=CheckNumerics)</span><br><span class="line">fold_old_batch_norms</span><br><span class="line">&#x27;</span><br></pre></td></tr></table></figure>
<p>在<code>transforms</code>里面加入你想进行优化的 transformer 和对应的参数即可，在科赛上也有在线可以跑的<a target="_blank" rel="noopener" href="https://www.kesci.com/home/project/5c8219e31e7104002b3747d6">notebook</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/ml-engine/docs/tensorflow/deploying-models#build_an_optimal_prediction_graph">Cloud ML Engine</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/12/11/etcd-raft-code-walkthrough/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/12/11/etcd-raft-code-walkthrough/" class="post-title-link" itemprop="url">etcd/raft code walkthrough</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-11 23:51:03" itemprop="dateCreated datePublished" datetime="2018-12-11T23:51:03+08:00">2018-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/12/11/etcd-raft-code-walkthrough/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/12/11/etcd-raft-code-walkthrough/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我照着 raft 论文重新过了一遍 etcd/raft 的代码，主要的文件是 etcd 下面的 <code>raft.go</code>。对照这个代码重新梳理一遍也算是深入理解一下 raft 算法。接下来会包含两个视频一个是选举相关的内容，一个是日志复制的内容，我 walktrough 的时候默认是大致读过论文的，对一些机制和字段都有了解，没有具体解析每个字段的来历，并且把一些问题按照代码的顺序重新理了一遍。</p>
<p>第一部分是关于选举的，raft 本身是一个 quorum based 的算法，一致性要靠“大多数人”的同意，并且为了简单和不必要的竞争，raft 只有一个主节点，在收到大多数人的投票以后成为主节点。</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/Qo45IJbSr3k" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<p>第二部分是关于日志复制的，raft 需要让主节点把客户端的请求复制到大多数节点上才能算达成一致，并且 commit，下面介绍的是复制的机制，并且 ConfChange 和 Snapshot 也是走这个流程达成一致的。</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/WjsrdYQ1SH0" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<p>之后的 walkthrough 应该会慢慢补上，关于一些其他的逻辑和具体的一些函数的细节部分会在后面放出。</p>
<h2 id="mvcc"><a href="#mvcc" class="headerlink" title="mvcc"></a>mvcc</h2><p>v2 版本的实现存在 watcher 丢失或者丢失事件的问题，导致客户端要重新获取一遍。新版本是有本地嵌入式的数据库来避免这些问题。<br>mvcc 是 etcd v3 版本的存储实现主要有两个部分，一个是 backend 的 boltDB 和内存索引 key index。</p>
<p>BoltDB 是一个 B+ 树的嵌入式 KV store，相对于 leveldb 适用于写多读少的情况，我之前的<a href="https://ggaaooppeenngg.github.io/zh-CN/2017/03/31/%E4%BB%8E%E6%9C%B4%E7%B4%A0%E8%A7%A3%E9%87%8A%E5%87%BA%E5%8F%91%E8%A7%A3%E9%87%8Aleveldb%E7%9A%84%E8%AE%BE%E8%AE%A1/">文章</a>简单介绍了一下 leveldb 的设计，BoltDB 比较适合读多写少，或者存在大范围 scan 的情况下比较合适，还有类似 levedb 的产品 <a target="_blank" rel="noopener" href="https://blog.dgraph.io/post/badger/">badger</a>，是纯 Go 实现的，在多写的情况下 leveldb 的衍生品表现更好。</p>
<p>BatchTx 就是收集很多的 call，然后在一个 Update 里面完成。</p>
<p>backend 里面存的 key 是 revision ，其中 main revision 是事务编号，sub revision 是事务中操作的编号，etcd 在 boltdb 上还做了一层缓存，所以多了一些锁机制。<br>内存索引中存的是真正的 key 到 revison 的索引。</p>
<p>key_index -&gt; tx_buffer -&gt; boltdb.tx</p>
<p>调用路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kv:</span><br><span class="line">  WriteView 是一些直接操作</span><br><span class="line">  ReadView</span><br><span class="line">  Read() TxnRead</span><br><span class="line">  Write() TxnWrite 是拿到对应的 transaction</span><br><span class="line"></span><br><span class="line">revision:</span><br><span class="line">  main</span><br><span class="line">  sub</span><br><span class="line">kvstore:</span><br><span class="line">  readView readView&#123;kv&#125; 用了 Read() Read/Write 是 kvstore 自己实现的用于拿 backend 的和自己的各种锁。(kvstore\_txn.go)</span><br><span class="line">  writeView writeView&#123;kv&#125; 用了 Write()</span><br><span class="line">treeIndex:</span><br><span class="line">  keyIndex</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">writeView:</span><br><span class="line">  拿到 kv 的 Write(storeTxnWrite):  首先查 tw.s.kvindex.Get 然后再 backend.Tx UnsageSeqPut，然后更新 keyindex，append changes，处理 lease (old detach new attach)</span><br><span class="line">readView</span><br><span class="line">   storeTxnRead: keyindex Revisons -&gt; tx.UnsafeRange</span><br><span class="line"></span><br><span class="line">lessor  lesor(重音在后面)</span><br><span class="line">   leaseBucket 在单独的一个 bucket 里面</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/11/10/K8S-%E4%B8%AD%E7%9A%84-eBPF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/11/10/K8S-%E4%B8%AD%E7%9A%84-eBPF/" class="post-title-link" itemprop="url">K8S 中的 eBPF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-11-10 18:36:25" itemprop="dateCreated datePublished" datetime="2018-11-10T18:36:25+08:00">2018-11-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/11/10/K8S-%E4%B8%AD%E7%9A%84-eBPF/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/11/10/K8S-中的-eBPF/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="BPF"><a href="#BPF" class="headerlink" title="BPF"></a>BPF</h2><p>BPF (Berkeley Packet Filter) 最早是用在 <code>tcpdump</code> 里面的，比如 <code>tcpdump tcp and dst port 80</code>  这样的过滤规则会单独复制 tcp 协议并且目的端口是 80 的包到用户态。整个实现是基于内核中的一个虚拟机来实现的，通过翻译 BPF 规则到字节码运行到内核中的虚拟机当中。最早的论文是<a target="_blank" rel="noopener" href="https://www.tcpdump.org/papers/bpf-usenix93.pdf">这篇</a>，这篇论文我大概翻了一下，主要讲的是原本的基于栈的过滤太重了，而 BPF 是一套能充分利用 CPU 寄存器，动态注册 filter 的虚拟机实现，相对于基于内存的实现更高效，不过那个时候的内存比较小才几十兆。bpf 会从链路层复制 pakcet 并根据 filter 的规则选择抛弃或者复制，字节码是这样的，具体语法就不介绍了，一般也不会去直接写这些字节码，然后通过内核中实现的一个虚拟机翻译这些字节码，注册过滤规则，这样不修改内核的虚拟机也能实现很多功能。</p>
<p>在 Linux 中对应的 API 是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket(SOCK_RAW)</span><br><span class="line">bind(iface)</span><br><span class="line">setsockopt(SO_ATTACH_FILTER)</span><br></pre></td></tr></table></figure>

<p>下面是一个低层级的 demo，首先 ethernet header 的十二个字节记录了 ip 的协议，ip 的第9个字节记录 tcp 的协议，如果协议编号不匹配都跳到最后 reject，然后在到 tcp 的第二个字节是 port 看看是不是 80，都满足的话就 accept。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/ethernet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netpacket/packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_LDH (BPF_LD  | BPF_H   | BPF_ABS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_LDB (BPF_LD  | BPF_B   | BPF_ABS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_JEQ (BPF_JMP | BPF_JEQ | BPF_K)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OP_RET (BPF_RET | BPF_K)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Filter TCP segments to port 80</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">bpfcode</span>[8] =</span> &#123;</span><br><span class="line">        &#123; OP_LDH, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>          &#125;,  <span class="comment">// ldh [12]                                                                                                                                                                                                                         </span></span><br><span class="line">        &#123; OP_JEQ, <span class="number">0</span>, <span class="number">5</span>, ETH_P_IP    &#125;,  <span class="comment">// jeq #0x800, L2, L8                                                                                                                                                                                                               </span></span><br><span class="line">        &#123; OP_LDB, <span class="number">0</span>, <span class="number">0</span>, <span class="number">23</span>          &#125;,  <span class="comment">// ldb [23]           # 14 bytes of ethernet header + 9 bytes in IP header until the protocol                                                                                                                                       </span></span><br><span class="line">        &#123; OP_JEQ, <span class="number">0</span>, <span class="number">3</span>, IPPROTO_TCP &#125;,  <span class="comment">// jeq #0x6, L4, L8                                                                                                                                                                                                                 </span></span><br><span class="line">        &#123; OP_LDH, <span class="number">0</span>, <span class="number">0</span>, <span class="number">36</span>          &#125;,  <span class="comment">// ldh [36]           # 14 bytes of ethernet header + 20 bytes of IP header (we assume no options) + 2 bytes of offset until the port                                                                                               </span></span><br><span class="line">        &#123; OP_JEQ, <span class="number">0</span>, <span class="number">1</span>, <span class="number">80</span>          &#125;,  <span class="comment">// jeq #0x50, L6, L8                                                                                                                                                                                                                </span></span><br><span class="line">        &#123; OP_RET, <span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>,         &#125;,  <span class="comment">// ret #0xffffffff    # (accept)                                                                                                                                                                                                    </span></span><br><span class="line">        &#123; OP_RET, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>           &#125;,  <span class="comment">// ret #0x0           # (reject)                                                                                                                                                                                                    </span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sock;</span><br><span class="line">	<span class="type">int</span> n;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">2000</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">addr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_mreq</span> <span class="title">mreq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span></span><br><span class="line">	<span class="type">char</span> saddr_str[INET_ADDRSTRLEN], daddr_str[INET_ADDRSTRLEN];</span><br><span class="line">	<span class="type">char</span> *proto_str;</span><br><span class="line">	<span class="type">char</span> *name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">bpf</span> =</span> &#123; <span class="number">8</span>, bpfcode &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s ifname\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	name = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	sock = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (sock &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">	addr.sll_ifindex = if_nametoindex(name);</span><br><span class="line">	addr.sll_family = AF_PACKET;</span><br><span class="line">	addr.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bind(sock, (<span class="keyword">struct</span> sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(addr))) &#123;</span><br><span class="line">		perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER, &amp;bpf, <span class="keyword">sizeof</span>(bpf))) &#123;</span><br><span class="line">		perror(<span class="string">&quot;setsockopt ATTACH_FILTER&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;mreq, <span class="number">0</span>, <span class="keyword">sizeof</span>(mreq));</span><br><span class="line">	mreq.mr_type = PACKET_MR_PROMISC;</span><br><span class="line">	mreq.mr_ifindex = if_nametoindex(name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sock, SOL_PACKET,</span><br><span class="line">				PACKET_ADD_MEMBERSHIP, (<span class="type">char</span> *)&amp;mreq, <span class="keyword">sizeof</span>(mreq))) &#123;</span><br><span class="line">		perror(<span class="string">&quot;setsockopt MR_PROMISC&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		n = recv(sock, buf, <span class="keyword">sizeof</span>(buf), <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (n &lt; <span class="number">1</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ip = (<span class="keyword">struct</span> iphdr *)(buf + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ether_header));</span><br><span class="line"></span><br><span class="line">		inet_ntop(AF_INET, &amp;ip-&gt;saddr, saddr_str, <span class="keyword">sizeof</span>(saddr_str));</span><br><span class="line">		inet_ntop(AF_INET, &amp;ip-&gt;daddr, daddr_str, <span class="keyword">sizeof</span>(daddr_str));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (ip-&gt;protocol) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTOSTR(_p,_str) \</span></span><br><span class="line"><span class="meta">			case _p: proto_str = _str; break</span></span><br><span class="line"></span><br><span class="line">		PTOSTR(IPPROTO_ICMP, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">		PTOSTR(IPPROTO_TCP, <span class="string">&quot;tcp&quot;</span>);</span><br><span class="line">		PTOSTR(IPPROTO_UDP, <span class="string">&quot;udp&quot;</span>);</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			proto_str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;IPv%d proto=%d(%s) src=%s dst=%s\n&quot;</span>,</span><br><span class="line">				ip-&gt;version, ip-&gt;protocol, proto_str, saddr_str, daddr_str);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>curl &quot;http://www.baidu.com&quot;</code>，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo ./filter ens3</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br><span class="line">IPv4 proto=6(tcp) src=172.31.3.210 dst=220.181.112.244</span><br></pre></td></tr></table></figure>

<p>这些低级别的操作都封装在了 libpcap 里面，一般不太会自己这么写。</p>
<h2 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h2><p>eBPF 是 extended BPF 具有更强大的功能。老的 BPF 现在叫 cBPF (classic BPF)。</p>
<p>首先是字节码的指令集更加丰富了，并且现在有了 64 位的寄存器（相较于上古时期的 32 位的CPU），有了 JIT mapping 技术和 LLVM 的后端。JIT 指的的是 Just In Time，实时编译。</p>
<p>一般的 ePBF 的工作流是编写一个 C 的子集（比如没有循环），通过 LLVM 编译到字节码，然成生成 ELF 文件，然后 JIT 编译进内核。</p>
<p>eBPF 一个最重要的功能是可以做到动态跟踪（dynamic tracing），可以不修改程序直接监控一个正在运行的进程。</p>
<h3 id="在-eBPF-之前"><a href="#在-eBPF-之前" class="headerlink" title="在 eBPF 之前"></a>在 eBPF 之前</h3><p>在 ebpf 之前，为了实现同样的功能，要在执行的指令中嵌入 hook，并且支持跳到 inspect 函数，然后再恢复执行，这个流程和 debugger 非常相似，这是用 kprobe 来实现，kprobe 是 2007 年引入内核的。比如下面的例子，把 Instruction 3 改成跳转指令，然后再执行 Instruction 3，然后再跳转回去。</p>
<img data-src="/zh-CN/2018/11/10/K8S-%E4%B8%AD%E7%9A%84-eBPF/image-20181110153643535.png" class="">

<p>使用 kprobe 需要通过编译 kernel module 注册到内核当中，非常麻烦，等于是直接动内核的代码很容易引起内核 panic，而且每个内核版本都不一样，函数符号和位移是有区别的，对每个版本的内核都要编译一个对应的版本的 module。为了解决这个问题引入了一些静态的稳定的 trace point，不会因为版本而改变的地方可以插入 kprobe，但这样就限制了 kprobe 可以探测的范围。</p>
<h3 id="有了-eBPF"><a href="#有了-eBPF" class="headerlink" title="有了 eBPF"></a>有了 eBPF</h3><p>有了 eBPF，就可以将用户态的程序插入到内核中，不用编写内核模块了，但是问题并没有改善，内核版本带来的问题还是没有解决。</p>
<p>eBPF 的 kprobe 一种方式时候 mapping，映射 kprobe 的数据到用户态程序，比如发包数，然后用户态程序定期检查这个映射进行统计。</p>
<p>另一种方式是 event (perf_events)，如果 kprobe 向用户态程序发送事件来进行统计，这样不同轮询，直接异步计算就可以。</p>
<p>低级别的 API，这个只有 Linux 有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bpf() 系统调用</span><br><span class="line">BPF_PROG_LOAD 加载 BPF 字节码</span><br><span class="line">  BPF_PROG_TYPE_SOCKET_FILTER</span><br><span class="line">  BPF_PROG_TYPE_KPROBE</span><br><span class="line">BPF_MAP_* map 映射到 BPF 当中</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf_event_open() + ioctl(PERF_EVENT_IOC_SET_BPF)</span><br></pre></td></tr></table></figure>

<p>高级别的接口是 bcc（BPFcompiler collection），转换 c 到 LLVM-epbf 后端，并且前端是 python 的。可以实现动态加载 eBPF 字节码到内核中。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/weaveworks/scope">weave scope</a> 就是用 bcc 实现的 <a target="_blank" rel="noopener" href="https://github.com/weaveworks-plugins/scope-http-statistics">HTTP stats</a> 的统计。</p>
<p>在<a target="_blank" rel="noopener" href="https://github.com/weaveworks-plugins/scope-http-statistics/blob/master/ebpf-http-statistics.c#L25">这里</a>可以看到程序的主体，这里 hook 了内核函数 <code>skb_copy_datagram_iter</code>，这个函数有一个 tracepoint <code>trace_skb_copy_datagram_iovec</code>。在内核代码里面对应的是下面这段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *      skb_copy_datagram_iter - Copy a datagram to an iovec iterator.</span></span><br><span class="line"><span class="comment"> *      @skb: buffer to copy</span></span><br><span class="line"><span class="comment"> *      @offset: offset in the buffer to start copying from</span></span><br><span class="line"><span class="comment"> *      @to: iovec iterator to copy to</span></span><br><span class="line"><span class="comment"> *      @len: amount of data to copy from buffer to iovec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">skb_copy_datagram_iter</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sk_buff *skb, <span class="type">int</span> offset,</span></span><br><span class="line"><span class="params">                           <span class="keyword">struct</span> iov_iter *to, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> start = skb_headlen(skb);</span><br><span class="line">        <span class="type">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">        trace_skb_copy_datagram_iovec(skb, len);</span><br></pre></td></tr></table></figure>

<p>这里对这个 hook 注册了程序，具体的代码就不展示了，主要是根据协议统计这个 HTTP 的大小，方法等信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* skb_copy_datagram_iter() (Kernels &gt;= 3.19) is in charge of copying socket</span></span><br><span class="line"><span class="comment"> * buffers from kernel to userspace.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * skb_copy_datagram_iter() has an associated tracepoint</span></span><br><span class="line"><span class="comment"> * (trace_skb_copy_datagram_iovec), which would be more stable than a kprobe but</span></span><br><span class="line"><span class="comment"> * it lacks the offset argument.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kprobe__skb_copy_datagram_iter</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx, <span class="type">const</span> <span class="keyword">struct</span> sk_buff *skb, <span class="type">int</span> offset, <span class="type">void</span> *unused_iovec, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>比如判断 method 是不是 DELETE 的是实现就比较蠢，是因为 eBPF 不支持循环，只能这么实现才能把 c 代码翻译成字节码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">	<span class="keyword">if</span> ((data[<span class="number">1</span>] != <span class="string">&#x27;E&#x27;</span>) || (data[<span class="number">2</span>] != <span class="string">&#x27;L&#x27;</span>) || (data[<span class="number">3</span>] != <span class="string">&#x27;E&#x27;</span>) || (data[<span class="number">4</span>] != <span class="string">&#x27;T&#x27;</span>) || (data[<span class="number">5</span>] != <span class="string">&#x27;E&#x27;</span>) || (data[<span class="number">6</span>] != <span class="string">&#x27; &#x27;</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>除了 bcc 之外，waeve 使用了 <a target="_blank" rel="noopener" href="https://github.com/iovisor/gobpf">gobpf</a>，一个 bpf 的 go binding，并且通过建立 tcp 连接来猜测内核的数据结构，以达到内核版本无关，这个项目 <a target="_blank" rel="noopener" href="https://github.com/weaveworks/tcptracer-bpf">tcptracer-bpf</a> 还在开发中。</p>
<h3 id="eBPF-的其他应用"><a href="#eBPF-的其他应用" class="headerlink" title="eBPF 的其他应用"></a>eBPF 的其他应用</h3><p>还有一个比较大头的基于 eBPF 的是 <a target="_blank" rel="noopener" href="https://github.com/cilium/cilium">cilium</a>，一套比较完整的网络解决方案，用 eBPF 实现了 NAT，L3/L4 负载均衡，连接记录等等功能。比如访问控制，一般的 iptables 都是 drop 或者 rst，要过整个协议栈，但是 eBPF 可以在 connect 的时候就拦截然后返回 EACCESS，这样就不用过协议栈了。cilium 一个优化就是通过 <a target="_blank" rel="noopener" href="https://github.com/iovisor/bpf-docs/blob/master/Express_Data_Path.pdf">XDP</a> ，利用类似 DPDK 的加速方案，hook 到驱动层中，让 eBPF 可以直接使用 DMA 的缓冲，优化负载均衡。</p>
<blockquote>
<p>BPF/XDP allows for a 10x improvement in load balancing over IPVS for L3/L4 traffic.</p>
</blockquote>
<p>现在 k8s 最新的 lb 方案是基于 ipvs 的，我在 <a href="https://ggaaooppeenngg.github.io/zh-CN/2018/09/10/kube-proxy-%E5%88%86%E6%9E%90/">kube-proxy 分析</a> 里面有提到过，已经比原来的 iptables 提高很多了，现在有了 eBPF 加 XDP 的硬件加速可以实现更高的提升，facebook 的 <a target="_blank" rel="noopener" href="https://github.com/facebookincubator/katran">katran</a> L4 负载均衡器的实现也是类似的。</p>
<p>cilium 在我看来基本上是 k8s 网络的一个大方向吧，只不过包括 eBPF 和 XDP 对硬件和内核版本都要比较新，是一个要持续关注的更新。</p>
<h4 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h4><p>在<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=bj3qdEDbCD4">Velocity 2017: Performance Analysis Superpowers with Linux eBPF</a>里，<a target="_blank" rel="noopener" href="https://www.youtube.com/channel/UCxzogoHFu8-1H9u522wVQpQ">Brendan Gregg</a> (Netflix 的性能调优专家) 提到，性能调优也是 eBPF 的一个大头。用于网络监控其实只是 hook 在了协议栈的函数上，如果 hook 在别的地方可以有更多的统计维度。比如 bcc 官方的例子就是统计 IO Size 的大小的分布，更多关于基于 eBPF 的性能调优可以参考他的 <a target="_blank" rel="noopener" href="http://www.brendangregg.com/linuxperf.html">blog</a>，他给出了更详细的关于 eBPF 的解释，里面有一些列 Linux 性能调优的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./bitehist.py</span></span><br><span class="line">Tracing... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     kbytes          : count     distribution</span><br><span class="line">       0 -&gt; 1        : 3        |                                      |</span><br><span class="line">       2 -&gt; 3        : 0        |                                      |</span><br><span class="line">       4 -&gt; 7        : 211      |**********                            |</span><br><span class="line">       8 -&gt; 15       : 0        |                                      |</span><br><span class="line">      16 -&gt; 31       : 0        |                                      |</span><br><span class="line">      32 -&gt; 63       : 0        |                                      |</span><br><span class="line">      64 -&gt; 127      : 1        |                                      |</span><br><span class="line">     128 -&gt; 255      : 800      |**************************************|</span><br></pre></td></tr></table></figure>

<h4 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h4><p>在安全方面有 seccomp，可以实现限制 Linux 的系统调用，而 <a target="_blank" rel="noopener" href="https://blog.yadutaf.fr/2014/05/29/introduction-to-seccomp-bpf-linux-syscall-filter/">seccompe-bpf</a> 则是通过 bpf 支持更强大的过滤和匹配功能，k8s pod 里面的 SecurityContext 就有 seccomp 实现的部分。</p>
<h4 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h4><p>在 cgroup 上有一个小原型，<a target="_blank" rel="noopener" href="https://github.com/kinvolk/cgnet">cgnet</a> 获取 cgroup 的网络统计信息到 prometheus，也是基于 eBPF 的。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><ol>
<li><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=k4jqTLtdrxQ">Infrastructure 2017 - Alfonso Acosta - High-performance Linux monitoring with eBPF</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://media.ccc.de/v/ASG2017-134-using_bpf_in_kubernetes#t=355">Using bpf in kubernetes</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://opensource.googleblog.com/2016/11/cilium-networking-and-security.html">Cilium: Networking and security for containers with BPF and XDP</a></p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/10/08/K8S-%E5%85%BC%E5%AE%B9-CSI-%E5%81%9A%E7%9A%84%E5%B7%A5%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/10/08/K8S-%E5%85%BC%E5%AE%B9-CSI-%E5%81%9A%E7%9A%84%E5%B7%A5%E4%BD%9C/" class="post-title-link" itemprop="url">K8S 兼容 CSI 做的工作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-10-08 00:41:41" itemprop="dateCreated datePublished" datetime="2018-10-08T00:41:41+08:00">2018-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/10/08/K8S-%E5%85%BC%E5%AE%B9-CSI-%E5%81%9A%E7%9A%84%E5%B7%A5%E4%BD%9C/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/10/08/K8S-兼容-CSI-做的工作/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>csi 是一个标准的容器存储接口，规定了如何实现一个容器的存储接口，CSI 本身的定义是基于 gRPC 的，所以有一套样例库可以使用，这里分析一下 kuberntes 实现 csi 的方式，为了兼容 CSI kubernete 其实搞得挺绕的，目前这个 CSI 还是定制中包括后期的 Snapshot 的接口怎么设计等等还在讨论中。kubernetes CSI 主要基于几个外部组件和内部功能的一些改动。</p>
<h2 id="CSI-Driver"><a href="#CSI-Driver" class="headerlink" title="CSI-Driver"></a>CSI-Driver</h2><p><a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec">这里</a>规定了 CSI 的标准，定义了三个 Service，也就是 RPC 的集合，但是没规定怎么写，目前看到的实现都是把这三个 service 都写在一起，比较方便，然后部署的时候有些区别将就可以。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Identity</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginInfo(GetPluginInfoRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (GetPluginInfoResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginCapabilities(GetPluginCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (GetPluginCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Probe (ProbeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ProbeResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Controller</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateVolume (CreateVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteVolume (DeleteVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerPublishVolume (ControllerPublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerPublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ValidateVolumeCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListVolumes (ListVolumesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListVolumesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetCapacity (GetCapacityRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (GetCapacityResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetCapabilities (ControllerGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateSnapshot (CreateSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteSnapshot (DeleteSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListSnapshots (ListSnapshotsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListSnapshotsResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeStageVolume (NodeStageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeStageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnstageVolume (NodeUnstageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnstageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodePublishVolume (NodePublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodePublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnpublishVolume (NodeUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetVolumeStats (NodeGetVolumeStatsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetVolumeStatsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// NodeGetId is being deprecated in favor of NodeGetInfo and will be</span></span><br><span class="line">  <span class="comment">// removed in CSI 1.0. Existing drivers, however, may depend on this</span></span><br><span class="line">  <span class="comment">// RPC call and hence this RPC call MUST be implemented by the CSI</span></span><br><span class="line">  <span class="comment">// plugin prior to v1.0.</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetId (NodeGetIdRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetIdResponse) </span>&#123;</span><br><span class="line">    <span class="keyword">option</span> deprecated = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetCapabilities (NodeGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prior to CSI 1.0 - CSI plugins MUST implement both NodeGetId and</span></span><br><span class="line">  <span class="comment">// NodeGetInfo RPC calls.</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetInfo (NodeGetInfoRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetInfoResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如说 <code>GetPluginInfo</code> 就是用来获取 driver 的 name 等信息的，<code>NodePublishVolume</code> 大部分情况下就是在节点上挂载文件系统，<code>CreateVolume</code> 这个如果对应的是 ebs 这种块存储可能就是在 API 里面建一个 ebs，如果对应的是 glusterfs 这种文件系统存储可能就是建一个 volume，然后 <code>ControllerPublishVolume</code> 对应 ebs 就是把 ebs 和 instance 绑定，然后调用节点的 <code>NodePublishVolume</code> 来挂载，如果是文件存储，可能就不需要 ``ControllerPublishVolume` 了，因为不需要绑定快设备到机器上，直接挂到网络接口就可以，这一套标准的目的一个是为了兼容现有的存储方案，一个是为了让一些私有的 provider 能够比较容易的实现一套方案，而不需要做过多的迁移，甚至厂商都不需要开源代码，如果是要实现 in-tree 的存储代码肯定是要开源的，因为 kubernetes 是开源的。</p>
<h2 id="device-driver-registrar"><a href="#device-driver-registrar" class="headerlink" title="device-driver-registrar"></a>device-driver-registrar</h2><p>kubernetes 实现 csi 的兼容，首先需要一个外部组件 devide-driver-registrar，初始化的时候通过 csi-sock 的 RPC 获取 driver name 和 node id。</p>
<p>主要功能给 node 打上下面类似的 annotations，dirver 对应的是 csi driver 的名字，name 对应的是 driver 的 NodeId 基本上就是 k8s 的 node name。这样可以让 <code>ControllerPublishVolume</code> 调用能够获取 nodeid 到 storage nodeid 的映射，理论上一样的就可以感觉。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csi.volume.kubernetes.io/nodeid: &quot;&#123; &quot;driver1&quot;: &quot;name1&quot;, &quot;driver2&quot;: &quot;name2&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>他有两个模式，一个模式是自己给 node 打上这个 annotation，并且在退出的时候把这个 annotation 去掉。</p>
<p>另一个模式是交给 kubelet 的 pluginswatcher 来管理， kubelet 自己会根据 device-driver-registrar 提供的 unix domain socket 然后调用 gRPC 从 registrar 获取 NodeId 和 DriverName 自己把 annotation 打上。</p>
<p>搜索这条路径下的 socket<code>/var/lib/kubelet/plugins/[SanitizedCSIDriverName]/csi.sock</code>，然后就可以自动连接 registrar 拿到 NodeId 和 DriverName。</p>
<p>所以 device-driver-registar 主要是注册 Node annotation 的。</p>
<h2 id="external-attacher"><a href="#external-attacher" class="headerlink" title="external-attacher"></a>external-attacher</h2><p>监听 VolumeAttachments 和 PersistentVolumes 两个对象，这是和 kube-controller-manager 之间的桥梁。</p>
<p>实现中最后会调用 <code>SyncNewOrUpdatedVolumeAttachment</code> 来同步，调用 csi dirver 的 Attach 函数。</p>
<h3 id="in-tree-的-attach-detach-controller"><a href="#in-tree-的-attach-detach-controller" class="headerlink" title="in-tree 的 attach/detach-controller"></a>in-tree 的 attach/detach-controller</h3><p>在 CSI 中扮演的角色是创建 VolumeAttachment，然后等待他的 VolumeAttachment 的 attached 的状态。</p>
<p>attach-controller 会创建 <code>VolumeAttatchment.Spec.Attacher</code> 指向的是 <code>external-attacher</code></p>
<h2 id="external-provisoner"><a href="#external-provisoner" class="headerlink" title="external-provisoner"></a>external-provisoner</h2><p><code>Static Volume</code> 和 <code>Dynamic Volume</code> 的区别是，有一个 PersistentVolumeClaim 这个会根据 claim 自动分配 PersistentVolume，不然就要自己手动创建，然后 pod 要指定这个手动创建的 volume。</p>
<p>external-provisoner 就是提供支持 PersistentVolumeClaim 的，一般的 provisioner 要实现 Provision 和 Delete 的接口。主要是根据 PVC 创建 PV，这是 Provisioner 的接口的定义了，不是 CSI spec 里的，这里顺带介绍一下。</p>
<p>external-provisoner 看到 pvc 调用 <code>driver</code> 的 CreateVolume，完成以后就会创建 PersistenVolume，并且绑定到 pvc。</p>
<h2 id="kubelet-volume-manager"><a href="#kubelet-volume-manager" class="headerlink" title="kubelet volume manager"></a>kubelet volume manager</h2><p>kubelet 有一个 volume manager 来管理 volume 的 mount/attach 操作。</p>
<p><code>desiredStateOfWorld</code> 是从 podManager 同步的理想状态。</p>
<p><code>actualStateOfWorld</code> 是目前 kubelet 的上运行的 pod 的状态。</p>
<p>每次 volume manager 需要把 <code>actualStateOfWorld</code> 中 volume 的状态同步到 desired 指定的状态。</p>
<p>volume Manager 有两个 goroutine 一个是同步状态，一个 reconciler.reconcile</p>
<p> rc.operationExecutor.MountVolume 会执行 MountVolume 的操作。</p>
<p>-&gt; oe.operationGenerator.GenerateMountVolumeFunc </p>
<p>-&gt; 首先根据 og.volumePluginMgr.FindPluginBySpec 找到对应的 VolumePlugin</p>
<p>-&gt; 然后调用 volumePlugin.NewMounter</p>
<p>-&gt; 然后拿到  og.volumePluginMgr.FindAttachablePluginBySpec attachableplugin</p>
<p>-&gt; volumeMounter.SetUp(fsGroup) 做 mount</p>
<h3 id="volume-plugin"><a href="#volume-plugin" class="headerlink" title="volume plugin"></a>volume plugin</h3><p>csi volume plugin 是一个 in-tree volume，以后应该会逐步迁移到都使用 csi，而不会再有 in-tree volume plugin 了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *csiMountMgr)</span></span> SetUp(fsGroup *<span class="type">int64</span>) <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c.SetUpAt(c.GetPath(), fsGroup)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>csi 的 mounter 调用了 NodePublish 函数。stagingTargetPath 和 targetPath 都是自动生成的。</p>
<p> <code>SetUp</code>/<code>TearDown</code> 的调用会执行 in-tree CSI plugin 的接口（这又是 in-tree volume plugin 的定义，确实挺绕的），对应的是  <code>NodePublishVolume</code> 和 <code>NodeUnpublishVolume</code> ，这个会通过 unix domain socket 直接调用 csi driver。</p>
<h2 id="总结一个简单的具体流程"><a href="#总结一个简单的具体流程" class="headerlink" title="总结一个简单的具体流程"></a>总结一个简单的具体流程</h2><p>首先管理员创建 StorageClass 指向 external-provisioner，然后用户创建指向这个 StorageClass 的 pvc，然后 kube-controller-manager 里的 persistent volume manager 会把这个 pvc 打上 <code>volume.beta.kubernetes.io/storage-provisioner</code> 的 annotation。</p>
<p>externla-provisioner 看到这个 pvc 带有自己的 annotation 以后，拿到 StorageClass 提供的一些参数，并且根据 StorageClass 和 pvc 调用 CSI driver 的 <code>CreateVolume</code>，创建成功以后创建 pv，并且把这个 pv 绑定到对应的 pvc。</p>
<p>然后 kube-controller-manager 看到有 pod 含有对应的 pvc，就用调用 in-tree 的 CSI plugin 的 attach 方法。</p>
<p>in-tree 的 CSI plugin 实际上会创建一个 VolumeAttachment 的 object，等待这个 VolumeAttachment 被完成。</p>
<p>external-controller 看到 VolumeAttachment，开始 attach 一个 volume，实际上调用 CSI driver 的 <code>ControllerPublish</code>，成功以后更新 <code>VoluemAttachment</code> 以后就知道这个 Volume Attach 成功了，然后让 attach/detach-controller (kube-controller-manager) 知道这个 attach 完成。</p>
<p>接下来就到 kubelet 了，kubelet 看到 volume in pod 以后就会调用 in-tree 的 csi plugin WaitForAttach，然后等待 Attach 成功，之后就会调用 daemonset 里面的 csi driver 的 <code>NodePublishVolume</code> 做挂载操作。</p>
<p>整体的流程是这样的，需要反复多看几遍 kubernetes-csi 的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md">document</a>，加深理解。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/09/10/kube-proxy-%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/09/10/kube-proxy-%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">kube-proxy 分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-09-10 22:13:29" itemprop="dateCreated datePublished" datetime="2018-09-10T22:13:29+08:00">2018-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/09/10/kube-proxy-%E5%88%86%E6%9E%90/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/09/10/kube-proxy-分析/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>kube-proxy 是一层代理，主要用于实现 Service 这个 Object。</p>
<p>Service 有一个 ClusterIP，这是一个虚拟 IP 应对 Service 后面的 pod，pod 的销毁和创建会有 ip 不固定的问题。除了能够屏蔽后端的 pod 的 IP 之外，Service 还可以有负载均衡的作用。</p>
<p>Endpoint 维护的是 Service 和 Pod 的映射关系，如果 pods 变动，Endpoint 也会变动。Service 本身指定义了 ClusterIP 和 port 的映射。Endpoints 记录了 pod 的 ip 和端口。</p>
<p>主要的访问方式是通过 NAT 实现的，如果使用 iptables 的话，就设置匹配目标端口以后，DNAT 转发到目的地址。</p>
<blockquote>
<p> 我看代码的时候，发现有个函数叫 birth cry 挺有意思的，表示打程序启动的一条 log。</p>
</blockquote>
<p>Kube-proxy 主要监听两个对象，一个是 Service，一个是 Endpoint</p>
<p>这些 Objects 对应的处理函数有不同的实现，现在先看一下 iptables 的实现</p>
<p>当 Service 有更新的时候就会更新对应的 iptables 规则。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ServiceConfig)</span></span> Run(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) &#123;</span><br><span class="line">        <span class="keyword">defer</span> utilruntime.HandleCrash()</span><br><span class="line"></span><br><span class="line">        glog.Info(<span class="string">&quot;Starting service config controller&quot;</span>)</span><br><span class="line">        <span class="keyword">defer</span> glog.Info(<span class="string">&quot;Shutting down service config controller&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !controller.WaitForCacheSync(<span class="string">&quot;service config&quot;</span>, stopCh, c.listerSynced) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i := <span class="keyword">range</span> c.eventHandlers &#123;</span><br><span class="line">                glog.V(<span class="number">3</span>).Infof(<span class="string">&quot;Calling handler.OnServiceSynced()&quot;</span>)</span><br><span class="line">                c.eventHandlers[i].OnServiceSynced()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &lt;-stopCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会调用 OnServiceSynced，然后具体调用实现者的方法。</p>
<h2 id="Proxier"><a href="#Proxier" class="headerlink" title="Proxier"></a>Proxier</h2><h3 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h3><p>Netfilter 是内核模块的控制代码，ipvs 和 iptables 都是基于 Netfilter 实现的。</p>
<h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><p>用 iptables 配置 DNAT ，然后再用概率模块做负载均衡。kube-proxy iptables 的实现主要依赖于 filter 和 nat。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Masquerade</span></span><br><span class="line">-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000</span><br><span class="line">-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -m mark --mark 0x4000/0x4000 -j MASQUERADE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">clusterIP and publicIP</span></span><br><span class="line">-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.98.154.163/32 -p tcp -m comment --comment &quot;default/nginx: cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SERVICES -d 10.98.154.163/32 -p tcp -m comment --comment &quot;default/nginx: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-4N57TFCL4MD7ZTDA</span><br><span class="line">-A KUBE-SERVICES -d 12.12.12.12/32 -p tcp -m comment --comment &quot;default/nginx: loadbalancer IP&quot; -m tcp --dport 80 -j KUBE-FW-4N57TFCL4MD7ZTDA</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Masq <span class="keyword">for</span> publicIP</span></span><br><span class="line">-A KUBE-FW-4N57TFCL4MD7ZTDA -m comment --comment &quot;default/nginx: loadbalancer IP&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-FW-4N57TFCL4MD7ZTDA -m comment --comment &quot;default/nginx: loadbalancer IP&quot; -j KUBE-SVC-4N57TFCL4MD7ZTDA</span><br><span class="line">-A KUBE-FW-4N57TFCL4MD7ZTDA -m comment --comment &quot;default/nginx: loadbalancer IP&quot; -j KUBE-MARK-DROP</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Masq <span class="keyword">for</span> nodePort</span></span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/nginx:&quot; -m tcp --dport 30938 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/nginx:&quot; -m tcp --dport 30938 -j KUBE-SVC-4N57TFCL4MD7ZTDA</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">load balance <span class="keyword">for</span> each endpoints</span></span><br><span class="line">-A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment &quot;default/nginx:&quot; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-UXHBWR5XIMVGXW3H</span><br><span class="line">-A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment &quot;default/nginx:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-TOYRWPNILILHH3OR</span><br><span class="line">-A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment &quot;default/nginx:&quot; -j KUBE-SEP-6QCC2MHJZP35QQAR</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">endpoint <span class="comment">#1</span></span></span><br><span class="line">-A KUBE-SEP-6QCC2MHJZP35QQAR -s 10.244.3.4/32 -m comment --comment &quot;default/nginx:&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-6QCC2MHJZP35QQAR -p tcp -m comment --comment &quot;default/nginx:&quot; -m tcp -j DNAT --to-destination 10.244.3.4:80</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">endpoint <span class="comment">#2</span></span></span><br><span class="line">-A KUBE-SEP-TOYRWPNILILHH3OR -s 10.244.2.4/32 -m comment --comment &quot;default/nginx:&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-TOYRWPNILILHH3OR -p tcp -m comment --comment &quot;default/nginx:&quot; -m tcp -j DNAT --to-destination 10.244.2.4:80</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">endpoint <span class="comment">#3</span></span></span><br><span class="line">-A KUBE-SEP-UXHBWR5XIMVGXW3H -s 10.244.1.2/32 -m comment --comment &quot;default/nginx:&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-UXHBWR5XIMVGXW3H -p tcp -m comment --comment &quot;default/nginx:&quot; -m tcp -j DNAT --to-destination 10.244.1.2:80</span><br></pre></td></tr></table></figure>

<p>这是一个实例，首先通过 clusterIP 的 -d 匹配目的地址，还有 dport 匹配目的端口，转入对应的 SVC 链。</p>
<p>SVC 联通过 -m statistic 模块负载均衡到不同的 Endpoint 链上，每个 Endpoint 链又有一个 DNAT 到对应的 pod</p>
<p>的 IP:port 上，总的来说就是用 DNAT 实现 clusterIP 的代理，用 statistic 模块实现按概率的负载均衡（按概率进入不同的 Endpoint 链当中）。</p>
<h3 id="ipvs"><a href="#ipvs" class="headerlink" title="ipvs"></a>ipvs</h3><p>ipvs 有相对更好的性能，更复杂的负载均衡的算法以及健康状态检查等。</p>
<p>可以看到 kube-ipvs0 上的  10.102.128.4 对应的 Service 的 ClusterIP，而 RealServer 映射到了不同的 Endpoint 上。</p>
<p>iptables 的匹配是 hash 的，而不同根据一个链一个链的匹配，效率更高。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl describe svc nginx-service</span></span><br><span class="line">Name:			nginx-service</span><br><span class="line">...</span><br><span class="line">Type:			ClusterIP</span><br><span class="line">IP:			    10.102.128.4</span><br><span class="line">Port:			http	3080/TCP</span><br><span class="line">Endpoints:		10.244.0.235:8080,10.244.1.237:8080</span><br><span class="line">Session Affinity:	None</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ip addr</span></span><br><span class="line">...</span><br><span class="line">73: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN qlen 1000</span><br><span class="line">    link/ether 1a:ce:f5:5f:c1:4d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.102.128.4/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ipvsadm -<span class="built_in">ln</span></span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>     </span><br><span class="line">TCP  10.102.128.4:3080 rr</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">10.244.0.235:8080            Masq    1      0          0</span>         </span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">10.244.1.237:8080            Masq    1      0          0</span>   </span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/08/06/glusterfs-writev-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/08/06/glusterfs-writev-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">glusterfs writev 的主要流程单分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-08-06 02:14:41" itemprop="dateCreated datePublished" datetime="2018-08-06T02:14:41+08:00">2018-08-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/08/06/glusterfs-writev-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/08/06/glusterfs-writev-主要流程分析/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>glusterfs 主要有以下几个组件</p>
<ul>
<li>gluster 命令行。</li>
<li>glusterd 管理进程。</li>
<li>glusterfsd 服务进程。</li>
<li>glusterfs 客户端 fuse 进程。</li>
</ul>
<p><code>glusterfs</code> 是靠 <code>translator  </code> 做分层设计的，类似于可插拔的模块的概念，对应的结构体是 <code>xlator_t</code>，因为是 C 写的，一些面向的对象的写法也是通过 <code>xlator</code> 实现的，可以理解 <code>xlator</code> 是类，具体的实现是对象。比如 <code>protocol/client</code> 是最后的 <code>xlator</code> 从客户端发送到网络，对应的 <code>storage/posix</code> 是服务端接受的最后一层交给服务器上的文件系统。每个  <code>xlator</code> 都会编译成一个单独的 .so 文件。通过指定配置文件可以把不同的 <code>xlator</code> 进行组装，加载 .so 以后，通过<code>dlsym</code> 查找 <code>xlator</code> 的符号（函数表），相当于获取 <code>xlator</code> 的公开接口。配置文件中的 <code>volume</code> 和 <code>subvolume</code> 对应了 <code>xlator</code> 的组织关系。</p>
<p>volfile 会配置在 <code>/var/lib/glusterd/vols/</code> 下面，对应的文件名是 volfile-id 选项指定的。<code>xlator_t</code> 定义在 <code>libglusterfs/src/xlator.h</code> 里面。下面这张图就可以看到各个 translator 的关系。</p>
<p>glusterfsd 最开始是 <code>protocol/server</code> 最后是 <code>storage/posix</code> 两个 xlator 作为开头和结束。</p>
<p>glusterfs (client) 是以<code>protocol/client</code> 结尾。</p>
<img data-src="/zh-CN/2018/08/06/glusterfs-writev-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/translator.png" class="">

<blockquote>
<p>那个 write-behind 应该对应的是缓存策略里面的 write back，异步写，而不是直写。</p>
</blockquote>
<p>这种设计的好处是方便扩展，你只要填补 <code>xlator</code> 的实现，编译成 .so ，放到链接目录下面，就可以加载进去，不用改整个 glusterfs 的代码。</p>
<p>glusterfs 的整个应用的结构也可以看一下。</p>
<img data-src="/zh-CN/2018/08/06/glusterfs-writev-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/overallprocess.png" class="">

<p>用户态是 fuse 实现的文件系统，通过网络协议走到 server，server 本身用的是本地的文件系统，glusterfs 推荐使用 xfs。</p>
<p>下面举个详细的例子。</p>
<p>以 <code>writev</code> 举例，（write 的本质也是 writev，这里的 v 指的是内存向量，写的时候用链表表示的内存向量可以减少内存的拷贝，因为要分配一段连续的内存，然后拷到一起很没有效率，而且系统调用本身也支持这个系统调用，走到底层是硬件支持的，硬件不支持，也能 hook 帮你再拷贝到一起，但上层就不用管这些细节了），他们的调用关系通过 <code>STACK_WIND</code> 和 <code>STACK_UNWIND</code> 实现，对于所有的 xlator 的 op 都是这种调用关系，本身一层结束以后通过调用 <code>STACK_WIND</code> 调用下一层对应的 op，然后在调用完成之后通过 <code>STACK_UNWIND</code> 回调 op_cbk，并且这种调用关系是树状的。</p>
<img data-src="/zh-CN/2018/08/06/glusterfs-writev-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/stack.png" class="">

<p>这张图解释挺好的，说明了 xlator 向下传递的过程，通过 <code>STACK_WIND</code> 调用下一层，通过 <code>STACK_UNWIND</code> 调用上一层的 cbk。</p>
<p><code>glusterfsd</code> 每个 volume 都会起一个线程来处理。</p>
<p><code>./xlators/mount/fuse/src/fuse-bridge.c</code> 下面是 <code>fuse</code> 的接口，这是客户端的入口，作为文件系统的“桥接点”，大概是为什么叫 bridge 的原因吧。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">fuse_handler_t</span> *fuse_std_ops[FUSE_OP_HIGH] = &#123;</span><br><span class="line">        [FUSE_LOOKUP]      = fuse_lookup,</span><br><span class="line">        [FUSE_FORGET]      = fuse_forget,</span><br><span class="line">        [FUSE_GETATTR]     = fuse_getattr,</span><br><span class="line">        [FUSE_SETATTR]     = fuse_setattr,</span><br><span class="line">        [FUSE_READLINK]    = fuse_readlink,</span><br><span class="line">        [FUSE_SYMLINK]     = fuse_symlink,</span><br><span class="line">        [FUSE_MKNOD]       = fuse_mknod,</span><br><span class="line">        [FUSE_MKDIR]       = fuse_mkdir,</span><br><span class="line">        [FUSE_UNLINK]      = fuse_unlink,</span><br><span class="line">        [FUSE_RMDIR]       = fuse_rmdir,</span><br><span class="line">        [FUSE_RENAME]      = fuse_rename,</span><br><span class="line">        [FUSE_LINK]        = fuse_link,</span><br><span class="line">        [FUSE_OPEN]        = fuse_open,</span><br><span class="line">        [FUSE_READ]        = fuse_readv,</span><br><span class="line">        [FUSE_WRITE]       = fuse_write,</span><br><span class="line">        [FUSE_STATFS]      = fuse_statfs,</span><br><span class="line">        [FUSE_RELEASE]     = fuse_release,</span><br><span class="line">        [FUSE_FSYNC]       = fuse_fsync,</span><br></pre></td></tr></table></figure>

<p>看一下  <code>fuse_write</code>，传了一个 <code>xlator_t</code> ，这个东西是 <code>glusterfs</code> 的分层设计的核心，每个 <code>fuse_in_header_t</code>  和 <code>msg</code> 还有 <code>iobuf</code> 都是 fuse 的 API。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">fuse_write</span> <span class="params">(<span class="type">xlator_t</span> *this, <span class="type">fuse_in_header_t</span> *finh, <span class="type">void</span> *msg,</span></span><br><span class="line"><span class="params">            <span class="keyword">struct</span> iobuf *iobuf)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/* WRITE is special, metadata is attached to in_header,</span></span><br><span class="line"><span class="comment">         * and msg is the payload as-is.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">fuse_write_in</span> *<span class="title">fwi</span> =</span> (<span class="keyword">struct</span> fuse_write_in *)</span><br><span class="line">                                      (finh + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">fuse_state_t</span>    *state = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">fd_t</span>            *fd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> FUSE_KERNEL_MINOR_VERSION &gt;= 9</span></span><br><span class="line">        <span class="type">fuse_private_t</span>  *priv = <span class="literal">NULL</span>;</span><br><span class="line">        priv = this-&gt;private;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        GET_STATE (this, finh, state);</span><br><span class="line">        fd          = FH_TO_FD (fwi-&gt;fh);</span><br><span class="line">        state-&gt;fd   = fd;</span><br><span class="line">        state-&gt;size = fwi-&gt;size;</span><br><span class="line">        state-&gt;off  = fwi-&gt;offset;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* lets ignore &#x27;fwi-&gt;write_flags&#x27;, but just consider &#x27;fwi-&gt;flags&#x27; */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> FUSE_KERNEL_MINOR_VERSION &gt;= 9</span></span><br><span class="line">        state-&gt;io_flags = fwi-&gt;flags;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        state-&gt;io_flags = fwi-&gt;write_flags;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> may need to handle below flag</span></span><br><span class="line"><span class="comment">           (fwi-&gt;write_flags &amp; FUSE_WRITE_CACHE);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        fuse_resolve_fd_init (state, &amp;state-&gt;resolve, fd);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* See comment by similar code in fuse_settatr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> FUSE_KERNEL_MINOR_VERSION &gt;= 9</span></span><br><span class="line">        priv = this-&gt;private;</span><br><span class="line">        <span class="keyword">if</span> (priv-&gt;proto_minor &gt;= <span class="number">9</span> &amp;&amp; fwi-&gt;write_flags &amp; FUSE_WRITE_LOCKOWNER)</span><br><span class="line">                state-&gt;lk_owner = fwi-&gt;lock_owner;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        state-&gt;<span class="built_in">vector</span>.iov_base = msg;</span><br><span class="line">        state-&gt;<span class="built_in">vector</span>.iov_len  = fwi-&gt;size;</span><br><span class="line">        state-&gt;iobuf = iobuf;</span><br><span class="line"></span><br><span class="line">        fuse_resolve_and_resume (state, fuse_write_resume);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是传入了写入文件的描述符，要写的内存的段的地址和大小，iobuf 这个结构体和内核里的 iobuf 是查不多的。然后进到 <code>fuse_resolve_and_resume</code>，这个函数主要是解析一些文件的元数据，并且返回到 <code>writev_resume</code> 这个回调函数上，解析的函数在 <code>./xlators/mount/fuse/src/fuse-resolve.c</code> 下面，这整个是个状态机的写法，主要是解析 fd，父路径，inode 等信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">fuse_resolve</span> <span class="params">(<span class="type">fuse_state_t</span> *state)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">fuse_resolve_t</span>   *resolve = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        resolve = state-&gt;resolve_now;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resolve-&gt;fd) &#123;</span><br><span class="line"></span><br><span class="line">                fuse_resolve_fd (state);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!gf_uuid_is_null (resolve-&gt;pargfid)) &#123;</span><br><span class="line"></span><br><span class="line">                fuse_resolve_parent (state);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!gf_uuid_is_null (resolve-&gt;gfid)) &#123;</span><br><span class="line"></span><br><span class="line">                fuse_resolve_inode (state);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fuse_resolve_all (state);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到了回到调  <code>fuse_write_resume</code> 上，包了一层引用计数就往下传了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iobref_add (iobref, state-&gt;iobuf);</span><br><span class="line"></span><br><span class="line">gf_log (<span class="string">&quot;glusterfs-fuse&quot;</span>, GF_LOG_TRACE,</span><br><span class="line">        <span class="string">&quot;%&quot;</span>PRIu64<span class="string">&quot;: WRITE (%p, size=%&quot;</span>GF_PRI_SIZET<span class="string">&quot;, offset=%&quot;</span>PRId64<span class="string">&quot;)&quot;</span>,</span><br><span class="line">        state-&gt;finh-&gt;unique, state-&gt;fd, state-&gt;size, state-&gt;off);</span><br><span class="line"></span><br><span class="line">FUSE_FOP (state, fuse_writev_cbk, GF_FOP_WRITE, writev, state-&gt;fd,</span><br><span class="line">          &amp;state-&gt;<span class="built_in">vector</span>, <span class="number">1</span>, state-&gt;off, state-&gt;io_flags, iobref,</span><br><span class="line">          state-&gt;xdata);</span><br><span class="line"></span><br><span class="line">iobref_unref (iobref);</span><br></pre></td></tr></table></figure>

<p>fuse_writev_cbk 里面 <code>send_fuse_obj</code> 把 <code>iobuf</code>发送出去。<code>send_fuse_data</code>  到 <code>send_fuse_iov</code>，</p>
<p>然后走整个的 <code>xlator</code> 的 writev 调用链，到 <code>client</code> 上，这里最主要的就是 submit_request 开始走网络 rpc 了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int32_t</span></span><br><span class="line"><span class="title function_">client3_3_writev</span> <span class="params">(<span class="type">call_frame_t</span> *frame, <span class="type">xlator_t</span> *this, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">clnt_args_t</span>    *args     = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">clnt_conf_t</span>    *conf     = <span class="literal">NULL</span>;</span><br><span class="line">        gfs3_write_req  req      = &#123;&#123;<span class="number">0</span>,&#125;,&#125;;</span><br><span class="line">        <span class="type">int</span>             op_errno = ESTALE;</span><br><span class="line">        <span class="type">int</span>             ret      = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!frame || !this || !data)</span><br><span class="line">                <span class="keyword">goto</span> unwind;</span><br><span class="line"></span><br><span class="line">        args = data;</span><br><span class="line">        conf = this-&gt;private;</span><br><span class="line"></span><br><span class="line">        ret = client_pre_writev (this, &amp;req, args-&gt;fd, args-&gt;size,</span><br><span class="line">                                 args-&gt;offset, args-&gt;flags, &amp;args-&gt;xdata);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                op_errno = -ret;</span><br><span class="line">                <span class="keyword">goto</span> unwind;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = client_fd_fop_prepare_local (frame, args-&gt;fd, req.fd);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                op_errno = -ret;</span><br><span class="line">                <span class="keyword">goto</span> unwind;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = client_submit_request (this, &amp;req, frame, conf-&gt;fops,</span><br><span class="line">                                     GFS3_OP_WRITE, client3_3_writev_cbk,</span><br><span class="line">                                     args-&gt;iobref, args-&gt;<span class="built_in">vector</span>, args-&gt;count,</span><br><span class="line">                                     <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>,</span><br><span class="line">                                     (<span class="type">xdrproc_t</span>)xdr_gfs3_write_req);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * If the lower layers fail to submit a request, they&#x27;ll also</span></span><br><span class="line"><span class="comment">                 * do the unwind for us (see rpc_clnt_submit), so don&#x27;t unwind</span></span><br><span class="line"><span class="comment">                 * here in such cases.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                gf_msg (this-&gt;name, GF_LOG_WARNING, <span class="number">0</span>, PC_MSG_FOP_SEND_FAILED,</span><br><span class="line">                        <span class="string">&quot;failed to send the fop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GF_FREE (req.xdata.xdata_val);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">unwind:</span><br><span class="line">        CLIENT_STACK_UNWIND (writev, frame, <span class="number">-1</span>, op_errno, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        GF_FREE (req.xdata.xdata_val);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回调就会开始释放内存等等操作，这里就略过了，这里回到 fuse 的 writev_cbk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">fuse_writev_cbk</span> <span class="params">(<span class="type">call_frame_t</span> *frame, <span class="type">void</span> *cookie, <span class="type">xlator_t</span> *this,</span></span><br><span class="line"><span class="params">                 <span class="type">int32_t</span> op_ret, <span class="type">int32_t</span> op_errno,</span></span><br><span class="line"><span class="params">                 <span class="keyword">struct</span> iatt *stbuf, <span class="keyword">struct</span> iatt *postbuf, <span class="type">dict_t</span> *xdata)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">fuse_state_t</span> *state = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">fuse_in_header_t</span> *finh = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">fuse_write_out</span> <span class="title">fwo</span> =</span> &#123;<span class="number">0</span>, &#125;;</span><br><span class="line"></span><br><span class="line">        state = frame-&gt;root-&gt;state;</span><br><span class="line">        finh = state-&gt;finh;</span><br><span class="line"></span><br><span class="line">        fuse_log_eh_fop(this, state, frame, op_ret, op_errno);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (op_ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                gf_log (<span class="string">&quot;glusterfs-fuse&quot;</span>, GF_LOG_TRACE,</span><br><span class="line">                        <span class="string">&quot;%&quot;</span>PRIu64<span class="string">&quot;: WRITE =&gt; %d/%&quot;</span>GF_PRI_SIZET<span class="string">&quot;,%&quot;</span>PRId64<span class="string">&quot;/%&quot;</span>PRIu64,</span><br><span class="line">                        frame-&gt;root-&gt;unique,</span><br><span class="line">                        op_ret, state-&gt;size, state-&gt;off, stbuf-&gt;ia_size);</span><br><span class="line"></span><br><span class="line">                fwo.size = op_ret;</span><br><span class="line">                send_fuse_obj (this, finh, &amp;fwo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                gf_log (<span class="string">&quot;glusterfs-fuse&quot;</span>, GF_LOG_WARNING,</span><br><span class="line">                        <span class="string">&quot;%&quot;</span>PRIu64<span class="string">&quot;: WRITE =&gt; -1 gfid=%s fd=%p (%s)&quot;</span>,</span><br><span class="line">                        frame-&gt;root-&gt;unique,</span><br><span class="line">                        (state-&gt;fd &amp;&amp; state-&gt;fd-&gt;inode) ?</span><br><span class="line">                        uuid_utoa (state-&gt;fd-&gt;inode-&gt;gfid) : <span class="string">&quot;nil&quot;</span>, state-&gt;fd,</span><br><span class="line">                        strerror (op_errno));</span><br><span class="line"></span><br><span class="line">                send_fuse_err (this, finh, op_errno);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free_fuse_state (state);</span><br><span class="line">        STACK_DESTROY (frame-&gt;root);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>send_fuse_obj</code> 是一个宏实际上是 <code>send_fuse_data</code>，把 fuse_write_out 传给 fuse 告诉 fuse 写出了多少，或者返回错误给 fuse。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> send_fuse_obj(this, finh, obj) \</span></span><br><span class="line"><span class="meta">        send_fuse_data (this, finh, obj, sizeof (*(obj)))</span></span><br></pre></td></tr></table></figure>

<p>整个的分析过程大概是从客户端的角度来看的，glusterfs 比较重要的一个 <code>xlator</code> 就是 dht xlator，distributed hash table，这个 xlator 决定了文件的分布。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/05/29/Tensorflow-%E7%9A%84-Tensor-%E5%92%8C-OpKernel-%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/05/29/Tensorflow-%E7%9A%84-Tensor-%E5%92%8C-OpKernel-%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Tensorflow 的 Tensor 和 OpKernel 分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-29 00:58:26" itemprop="dateCreated datePublished" datetime="2018-05-29T00:58:26+08:00">2018-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/05/29/Tensorflow-%E7%9A%84-Tensor-%E5%92%8C-OpKernel-%E5%88%86%E6%9E%90/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/05/29/Tensorflow-的-Tensor-和-OpKernel-分析/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Tensor 的用户 API 可以参考<a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/Tensor">这里</a>，这里做一下简单介绍。<strong>Tensor</strong> 是各种维度的向量和矩阵的统称，分 Tensor 和 SparseTensor。和 Tensor 不同，SparseTensor 存的是值以及值对应的 index，而 Tensor 存的是完整的矩阵。</p>
<p>举个例子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">a = tf.constant([<span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">b = tf.constant([<span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">c = tf.add(a, b)</span><br><span class="line">sess = tf.InteractiveSession()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a[0]=%s, a[1]=%s&quot;</span> % (a[<span class="number">0</span>].<span class="built_in">eval</span>(), a[<span class="number">1</span>].<span class="built_in">eval</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;c = %s&quot;</span> % c.<span class="built_in">eval</span>())</span><br><span class="line">sess.close()</span><br></pre></td></tr></table></figure>

<p>输出对应如下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="number">0</span>]=<span class="number">1</span>, a[<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">c = [<span class="number">3</span> <span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<p>Tensor 只有 eval 以后才能获得结果，是懒计算的。</p>
<h2 id="Tensor-的实现"><a href="#Tensor-的实现" class="headerlink" title="Tensor 的实现"></a>Tensor 的实现</h2><p>Tensor (<code>tensorflow/tensorflow/core/framework/tensor.h</code>) 依赖 TensorShape（<code>tensorflow/tensorflow/tensorflow/core/framework/tensor_shape.h</code>) 和 TensorBuffer (<code>tensorflow/tensorflow/core/framework/tensor.h</code>) 两个成员。</p>
<p>TensorShape 主要负责记录张量的形状。</p>
<p>而 <code>TensorBuffer</code> 主要负责管理 <code>Tensor</code> 的内存，<code>TensorBuffer</code> 继承自 <code>RefCounted</code> (<code>tensorflow/tensorflow/core/lib/core/refcount.h</code>)，具有引用计数的功能，用于对内存进行管理。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface to access the raw ref-counted data buffer.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TensorBuffer</span> : <span class="keyword">public</span> core::RefCounted &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  ~<span class="built_in">TensorBuffer</span>() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>他们的对应的关系如下。</p>
<img data-src="/zh-CN/2018/05/29/Tensorflow-%E7%9A%84-Tensor-%E5%92%8C-OpKernel-%E5%88%86%E6%9E%90/class.png" class="" title="[Tensor]">

<p>Tensor 从下往上看，其实就是一个带”形状“的内存，和 NumPy 的数组是差不多的。</p>
<h2 id="OpKernel"><a href="#OpKernel" class="headerlink" title="OpKernel"></a>OpKernel</h2><p>对于一个线性回归来说，是最简单也最好理解的模型，方便分析底层的代码实现。</p>
<p>$$ Y=XW+b $$</p>
<p>损失函数用平方差定义的，优化器是提督下降，这样一个模型可以用一下的 Python 代码实现，这个代码片段是截取的，如果要完整运行这个例子可以在<a target="_blank" rel="noopener" href="https://www.kesci.com/apps/home/project/5af5be99cb6ed25ca32804e9">这里</a>复现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">sess = tf.InteractiveSession()</span><br><span class="line">x = tf.placeholder(tf.float32,[<span class="literal">None</span>, x_train.shape[<span class="number">1</span>]])</span><br><span class="line">y = tf.placeholder(tf.float32,[<span class="literal">None</span>, <span class="number">1</span>])</span><br><span class="line">w = tf.Variable(tf.zeros([x_train.shape[<span class="number">1</span>],<span class="number">1</span>]))</span><br><span class="line">b = tf.Variable(tf.zeros([<span class="number">1</span>])) <span class="comment"># placeholder 不用加 None</span></span><br><span class="line">pred = tf.add(tf.matmul(x, w), b)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">cost = tf.reduce_mean(tf.square(y - pred))</span><br><span class="line">optimizer = tf.train.GradientDescentOptimizer(learning_rate=<span class="number">0.001</span>).minimize(cost)</span><br><span class="line">epochs = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">init.run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, epochs):</span><br><span class="line">    optimizer.run(feed_dict=&#123;x:x_train, y:y_train&#125;)</span><br><span class="line">    c = cost.<span class="built_in">eval</span>(feed_dict = &#123;x:x_train,y:y_train&#125;)</span><br><span class="line">    <span class="keyword">if</span> epoch%<span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        print_percentage(<span class="built_in">int</span>(c*<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\nEpoch: &#123;0&#125;, Error: &#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(epoch+<span class="number">1</span>, c))</span><br><span class="line"></span><br><span class="line">b_value = b.<span class="built_in">eval</span>()</span><br><span class="line">w_value = w.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Predicted Labels</span></span><br><span class="line">y_pred = pred.<span class="built_in">eval</span>(feed_dict=&#123;x: x_test&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mean Squared Error</span></span><br><span class="line">mse = tf.reduce_mean(tf.square(y_pred - y_test))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;MSE&quot;</span>, mse.<span class="built_in">eval</span>())</span><br><span class="line">sess.close()</span><br></pre></td></tr></table></figure>

<p>对应的训练结果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Epoch: 3000, Error: 0.25882452726364136</span><br><span class="line">MSE 0.30620116674806463</span><br></pre></td></tr></table></figure>

<p>可以看到，线性回归的模型主要依赖的两个 Operation 分别是 <code>tf.add</code> 和 <code>tf.matmul</code>，其他的复杂模型也是类似的逻辑，对应的 <code>OpKernel</code> 分别是 <code>AddOp</code>  和 <code>MatMulOp</code>，这里可以看一下具体的实现。</p>
<p>如果有源代码，可以连着源代码用 bazel 编译，可以参照<a target="_blank" rel="noopener" href="https://www.tensorflow.org/extend/adding_an_op">这里</a>自己编写一个 Op。</p>
<p><code>MatMulOp</code> 的实现在 <code>/tensorflow/core/kernels/matmul_op.cc</code> 下面，定义在<code>tensorflow/tensorflow/core/ops/math_ops.cc</code> 下面。<code>AddOp</code> 在  <code>/tensorflow/core/kernels/matmul_op.cc</code>，实现在 <code>/tensorflow/core/kernels/cwise_op_add_1.cc</code> 下面，依赖 <code>/tensorflow/tensorflow/core/kernels/cwise_ops_common.h</code> 的 <code>common</code> 的定义。</p>
<p><code>Add</code> 用的是 <code>Eigen</code> 的 <code>add</code> <code>/tensorflow/tensorflow/core/kernels/cwise_ops.h</code>，依赖<code>third_party/Eigen/src/Core/functors/BinaryFunctors.h</code>。</p>
<p>举个例子，看一下 <code>MatMulOp</code>， <code>MatMulOp</code> 的构造函数里面有一个 <code>OpKernelConstruction</code> 可以初始化 <code>OpKernel</code>，通过 <code>OpKernel</code> 可以获得这个 <code>Op</code> 的参数比如<code>transpose_a</code> 等等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Device, <span class="keyword">typename</span> T, <span class="type">bool</span> USE_CUBLAS&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MatMulOp</span> : <span class="keyword">public</span> OpKernel &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">MatMulOp</span><span class="params">(OpKernelConstruction* ctx)</span></span></span><br><span class="line"><span class="function">      : OpKernel(ctx), algorithms_set_already_(false) &#123;</span> <span class="comment">// 在执行构造函数之前，执行两个成员的构造函数</span></span><br><span class="line">    <span class="built_in">OP_REQUIRES_OK</span>(ctx, ctx-&gt;<span class="built_in">GetAttr</span>(<span class="string">&quot;transpose_a&quot;</span>, &amp;transpose_a_));</span><br><span class="line">    <span class="built_in">OP_REQUIRES_OK</span>(ctx, ctx-&gt;<span class="built_in">GetAttr</span>(<span class="string">&quot;transpose_b&quot;</span>, &amp;transpose_b_));</span><br><span class="line"></span><br><span class="line">    LaunchMatMul&lt;Device, T, USE_CUBLAS&gt;::<span class="built_in">GetBlasGemmAlgorithm</span>(</span><br><span class="line">        ctx, &amp;algorithms_, &amp;algorithms_set_already_);</span><br><span class="line">    use_autotune_ = <span class="built_in">MatmulAutotuneEnable</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>每个 OpKernel 都要实现一个 Compute 函数，可以看到这个 Compute 函数首先检查了两个 Tensor 是否是矩阵，然后检查两个矩阵的形状是否符合矩阵相乘的条件，然后根据形状分配 <code>TensorShape</code> 并且根据 <code>TensorShape</code> 分配新的 <code>Tensor</code> (其实顺便分配的 <code>TensorBuffer</code> 的内存空间)。然后通过 <code>LaunchMatMul</code> 真正执行相乘操作，因为这个计算过程，可能是用了 GPU，所以模版是带 Device 的（GPUDevice/CPUDevice）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* ctx)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> Tensor&amp; a = ctx-&gt;<span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="type">const</span> Tensor&amp; b = ctx-&gt;<span class="built_in">input</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that the dimensions of the two matrices are valid.</span></span><br><span class="line">  <span class="built_in">OP_REQUIRES</span>(ctx, TensorShapeUtils::<span class="built_in">IsMatrix</span>(a.<span class="built_in">shape</span>()),</span><br><span class="line">              errors::<span class="built_in">InvalidArgument</span>(<span class="string">&quot;In[0] is not a matrix&quot;</span>));</span><br><span class="line">  <span class="built_in">OP_REQUIRES</span>(ctx, TensorShapeUtils::<span class="built_in">IsMatrix</span>(b.<span class="built_in">shape</span>()),</span><br><span class="line">              errors::<span class="built_in">InvalidArgument</span>(<span class="string">&quot;In[1] is not a matrix&quot;</span>));</span><br><span class="line">  Eigen::array&lt;Eigen::IndexPair&lt;Eigen::DenseIndex&gt;, <span class="number">1</span>&gt; dim_pair;</span><br><span class="line">  dim_pair[<span class="number">0</span>].first = transpose_a_ ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">  dim_pair[<span class="number">0</span>].second = transpose_b_ ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OP_REQUIRES</span>(</span><br><span class="line">      ctx, a.<span class="built_in">dim_size</span>(dim_pair[<span class="number">0</span>].first) == b.<span class="built_in">dim_size</span>(dim_pair[<span class="number">0</span>].second),</span><br><span class="line">      errors::<span class="built_in">InvalidArgument</span>(</span><br><span class="line">          <span class="string">&quot;Matrix size-incompatible: In[0]: &quot;</span>, a.<span class="built_in">shape</span>().<span class="built_in">DebugString</span>(),</span><br><span class="line">          <span class="string">&quot;, In[1]: &quot;</span>, b.<span class="built_in">shape</span>().<span class="built_in">DebugString</span>()));</span><br><span class="line">  <span class="type">int</span> a_dim_remaining = <span class="number">1</span> - dim_pair[<span class="number">0</span>].first;</span><br><span class="line">  <span class="type">int</span> b_dim_remaining = <span class="number">1</span> - dim_pair[<span class="number">0</span>].second;</span><br><span class="line">  <span class="function">TensorShape <span class="title">out_shape</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      &#123;a.dim_size(a_dim_remaining), b.dim_size(b_dim_remaining)&#125;)</span></span>;</span><br><span class="line">  Tensor* out = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="built_in">OP_REQUIRES_OK</span>(ctx, ctx-&gt;<span class="built_in">allocate_output</span>(<span class="number">0</span>, out_shape, &amp;out));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (out-&gt;<span class="built_in">NumElements</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// If a has shape [0, x] or b has shape [x, 0], the output shape</span></span><br><span class="line">    <span class="comment">// is a 0-element matrix, so there is nothing to do.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (a.<span class="built_in">NumElements</span>() == <span class="number">0</span> || b.<span class="built_in">NumElements</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// If a has shape [x, 0] and b has shape [0, y], the</span></span><br><span class="line">    <span class="comment">// output shape is [x, y] where x and y are non-zero, so we fill</span></span><br><span class="line">    <span class="comment">// the output with zeros.</span></span><br><span class="line">    functor::SetZeroFunctor&lt;Device, T&gt; f;</span><br><span class="line">    <span class="built_in">f</span>(ctx-&gt;<span class="built_in">eigen_device</span>&lt;Device&gt;(), out-&gt;<span class="built_in">flat</span>&lt;T&gt;());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  LaunchMatMul&lt;Device, T, USE_CUBLAS&gt;::<span class="built_in">launch</span>(</span><br><span class="line">      ctx, a, b, dim_pair, &amp;algorithms_, use_autotune_, out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LaunchMatMul</code>  继承自<code> LaunchMatMulBase</code>，在 <code>LaunchMatMulBase</code> 当中调用了 <code>functor::MatMulFunctor</code>，这个 functor 主要就会执行乘法操作，在这之前会检查一下是否其中一个元素是 vector，这样可以直接优化算出来，而不用 Eigen 库来算，这样更快，这个目前看到的是 CPU 的路径。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Device, <span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">LaunchMatMulBase</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> GOOGLE_CUDA</span></span><br><span class="line">  <span class="keyword">typedef</span> se::blas::AlgorithmType AlgorithmType;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="keyword">typedef</span> int64 AlgorithmType;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// GOOGLE_CUDA</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">launch</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      OpKernelContext* ctx, <span class="type">const</span> Tensor&amp; a, <span class="type">const</span> Tensor&amp; b,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> Eigen::array&lt;Eigen::IndexPair&lt;Eigen::DenseIndex&gt;, <span class="number">1</span>&gt;&amp; dim_pair,</span></span></span><br><span class="line"><span class="params"><span class="function">      std::vector&lt;AlgorithmType&gt;* algorithms, <span class="type">bool</span> use_aututone, Tensor* out)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TENSORFLOW_USE_SYCL</span></span><br><span class="line">    <span class="comment">// An explicit vector-matrix multiply is much better optimized than an</span></span><br><span class="line">    <span class="comment">// implicit one and this is a bottleneck during non-batched inference.</span></span><br><span class="line">    <span class="type">bool</span> was_vector = <span class="built_in">ExplicitVectorMatrixOptimization</span>&lt;T&gt;(a, b, dim_pair, out);</span><br><span class="line">    <span class="keyword">if</span> (!was_vector) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// TENSORFLOW_USE_SYCL</span></span></span><br><span class="line">      functor::<span class="built_in">MatMulFunctor</span>&lt;Device, T&gt;()(ctx-&gt;<span class="built_in">eigen_device</span>&lt;Device&gt;(),</span><br><span class="line">                                          out-&gt;<span class="built_in">matrix</span>&lt;T&gt;(), a.<span class="built_in">matrix</span>&lt;T&gt;(),</span><br><span class="line">                                          b.<span class="built_in">matrix</span>&lt;T&gt;(), dim_pair);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TENSORFLOW_USE_SYCL</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// TENSORFLOW_USE_SYCL</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">GetBlasGemmAlgorithm</span><span class="params">(OpKernelConstruction* ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   std::vector&lt;int64&gt;* algorithms,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">bool</span>* algorithm_set_flag)</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>MatMulFunctor</code> 在设备  <code>d</code> 上计算矩阵相乘的结果，其中调用的是 <code>MatMul&lt;CPUDevice&gt;</code>。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Device, <span class="keyword">typename</span> In0, <span class="keyword">typename</span> In1, <span class="keyword">typename</span> Out,</span><br><span class="line">          <span class="keyword">typename</span> DimPair&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MatMul</span><span class="params">(<span class="type">const</span> Device&amp; d, Out out, In0 in0, In1 in1,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">const</span> DimPair&amp; dim_pair)</span> </span>&#123;</span><br><span class="line">  out.<span class="built_in">device</span>(d) = in<span class="number">0.</span><span class="built_in">contract</span>(in1, dim_pair);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <code>contract</code> 调用的是 <code>TensorContractionOp</code> (<code>third_party/unsupported/Eigen/CXX11/src/Tensor/TensorContraction.h</code>)，跟之前说的一样，这个 <code>Op</code> 是计算图的一部分，要通过 <code>eval</code> 来做计算，计算结果是 <code>eval</code> 驱动的。<code>TensorContractionOp</code> 的构造函数就是，这负责构建左表达式和右表达式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EIGEN_DEVICE_FUNC EIGEN_STRONG_INLINE <span class="title">TensorContractionOp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> LhsXprType&amp; lhs, <span class="type">const</span> RhsXprType&amp; rhs, <span class="type">const</span> Indices&amp; dims)</span></span></span><br><span class="line"><span class="function">    : m_lhs_xpr(lhs), m_rhs_xpr(rhs), m_indices(dims) &#123;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>真正的计算过程在 <code>TensorContractionEvaluatorBase</code> 里面，真正执行计算过程，计算细节就省略了主要是矩阵相乘。</p>
<h3 id="CUDA"><a href="#CUDA" class="headerlink" title="CUDA"></a>CUDA</h3><p>如果条件编译 <code>GOOGLE_CUDA</code> 的话，会使用 GPU 的代码，对应会调用到 steam executor，这个以后具体分析。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Tensorflow 基于图模型的，并且是懒计算的，通过扩展可以自己用 C++ 实现新的 Op，并且也可以观察默认自带的 OpKernel 是如何实现的，对于理解 Tensorflow 的工作流程会有很大的帮助。Tensorflow 本身依赖了 Eigen，CUDA 等线性代数库或者 GPU 计算库，要看懂代码还是要多学一点线代的知识，比如 <code>Contraction</code> 这个概念我也是第一次晓得。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li> <a target="_blank" rel="noopener" href="https://www.amazon.cn/dp/B07CLVXGLH">深入理解 Tensorflow 架构设计与原理实现</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">Raft 解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-27 21:36:31" itemprop="dateCreated datePublished" datetime="2018-05-27T21:36:31+08:00">2018-05-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/05/27/raft-解读/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Raft 的作者其实对 Paxos 研究得很深，毕竟 Paxos 基本上就是共识算法的代名词，建议在了解 Raft 之前先看看 Paxos，因为 Paxos 里面有一段从单点开始完整的推断共识算法的正确性和必要性的过程，方便建立一种对共识算法上直觉的认同。Raft 论文最好看作者的博士论文，那个比较完整。</p>
<h2 id="leader-election"><a href="#leader-election" class="headerlink" title="leader election"></a>leader election</h2><p>Raft 有 Term 的概念，把时间每分成了一个个的任期，每个任期开始是选举过程。Raft server 有三种角色，Candidate 就是选举中的状态，Leader 是当选的状态，Follower 是服从并选择接受 Leader 的 Log 的状态。</p>
<img data-src="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/raft-server-state.png" class="" title="[raft server state]">

<p>其实可以把选主看作一个 basic Paxos，大家对 leader=? 达成一致，触发的条件是超时和初始化的时候，term 就是类似于 Paxos 的 propose number，和 basic Paxos 不一样的是每个 term 只能投一个人，所以每个 term 不会有冲突，只有一个人会当选，但是会有平票的问题，大家用同一个 term 选举的情况下就会发生（比如说大家都投自己，谁都不接受谁），所以为了减少冲突，把重试的时间随机化，快速超时的人能拿到高 term，并且其他慢速超时的 candidate 会服从这个先拿到下一个 term 的 leader。成为 leader 的标志是收到了大部分人的服从(3/5 或者 2/3)。</p>
<img data-src="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/raft-terms.png" class="" title="[raft terms]">

<h2 id="log-replication"><a href="#log-replication" class="headerlink" title="log replication"></a>log replication</h2><img data-src="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/raft-log-conflict.png" class="" title="[raft log conflicts]">

<p>log 不一致的就以上几种情况，可能少了 entry，可能多了没 commited 的 entry，可能又少了 entry 还多了没 commited 的 entry，log 不一致的情况就这几种。index term 能唯一确定一个 entry，如果一个 entry  确定，之前的也确定了。基于上面的性质，如果 entry commited 之前的就是都 commited 了。这个通过 append 的 prev index prev term，来保证这个特性。解决方法是在 AppendRequest 里面带上新的 entry 前的 index 和 term（在 leader 那里存的前一个），如果这个 entry 不在 follower 里面的话，就拒绝追加新 entry，然后 leader 就要用前一个 index 尝试，直到开始出现 match 的点，有点像 git tree 里面开始产生分支的那个 base，这个过程一直减少自己保存的 follower 的 nextIndex，一直到获得和自己 match 的最后一个 index 开始追加复制自己的 log。也就是说这样会强迫所有的 follower 复制主节点的 log，这里有一个按 term 回溯 base 的方法，但是这个优化作者认为有点多此一举，毕竟错误发生的情况比较少。这里会有一个问题（啥问题），后面会通过选举的时候加上限制解决。</p>
<p>这个问题就是，新的 leader 可能没有之前 commited 的 log，然后修改了其他 follower 的 log，导致每个 state machine 执行的命令是不一致的，所以要加一个约束，在投票的时候，新的 leader 必须包含之前 commited 的 log，这个保证就需要通过定义 entry 的 update-to-date，在投票的时候拒绝比自己老的 leader 当选。</p>
<h2 id="safety"><a href="#safety" class="headerlink" title="safety"></a>safety</h2><p>这个问题被称作 <code>safety</code>，为了解决这个问题 update-to-date 怎么定义呢？比如下面这个例子，如果 S3 挂了，其实 index 5 已经 commited 了，但是没有办法确定 index 5 的这个 log 是否 commited 了。所以要选个最可能包含所有 log 的做 leader。</p>
<img data-src="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/raft-not-commited.png" class="" title="[raft not commited]">

<p>先比 term，再比 log 数量，按顺序比，有点像字符串比较，这样可以确保 leader 有其他 follower 的 entry。没有大多数人的又新又全就无法成为 leader。</p>
<h3 id="commit-from-previous-entry"><a href="#commit-from-previous-entry" class="headerlink" title="commit from previous entry"></a>commit from previous entry</h3><p>如果一个 leader 在 commit 之前 crash 了，并且新的 leader 没有已经在大多数节点上的 entry 可能会覆盖掉本该 commit 的 entry。</p>
<p>比如这图，如果是 (d1) 的情况，3 就会把 2 盖掉，但是实际上 2 本该 commited 了，但是在 commit 之前 S5 可能在 term 5 成为了主（这个没有违背上面的 upda-to-date 因为 3 确实比 2 要新，并且可以从 S2, S3, S4 那里获得选票）。</p>
<img data-src="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/raft-conflict-2.png" class="" title="[raft conflict 2]">

<p>光看数量，没办法替之前 term 的 entry commit，因为 d1 的情况，可能就把 2 盖掉了。只有 term 4 的时候 4 commit 了（当前的 term 可以 commit）才能替之前 term 的 entry commit（实际上间接 commit 了，这个可以证明），这样 term 3 就不会成为主，就不可能盖掉 2。</p>
<p><strong>总结一下，在 Raft 中 leader 不会 commit 之前 term 的 entry，只 commit 当前 term 的 entry。当前 term 的 entry commit 了，之前 term 的 entry 就间接 commit 了。</strong></p>
<h3 id="持久化数据"><a href="#持久化数据" class="headerlink" title="持久化数据"></a>持久化数据</h3><p>当前的 term 和 vote 。</p>
<h2 id="membership-change"><a href="#membership-change" class="headerlink" title="membership change"></a>membership change</h2><img data-src="/zh-CN/2018/05/27/raft-%E8%A7%A3%E8%AF%BB/raft-conf-change.png" class="" title="[raft conf change]">

<p>raft conf change 有几个主要阶段，其中 C(old)+c(new) 的情况下，需要服从两个 conf 的大多数，并且，每次只能一个一个的增加 server 和 减少 server。</p>
<p>参考文献</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://raft.github.io/">Raft Algorithm</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Paxos 总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-20 21:58:57" itemprop="dateCreated datePublished" datetime="2018-05-20T21:58:57+08:00">2018-05-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/05/20/paxos-总结/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Paxos-是什么"><a href="#Paxos-是什么" class="headerlink" title="Paxos 是什么"></a>Paxos 是什么</h2><blockquote>
<p>Paxos is a mechanism for achieving consensus on a single value over unreliable communication channels.</p>
</blockquote>
<p>Paxos 就是一个在不稳定的网络环境下建立的对一个值的共识。我们说的 Multi-Paxos 是指对多个值的共识，不过我们先一步一步来。</p>
<p>在 Paxos 中是没有 leader 这个概念的，所以相对来说会比较慢，因为谁都可以处理请求并且把自己的 peer 盖掉导致冲突，达成一致的过程会更长。</p>
<p>Paxos 只抵抗机器崩溃，网络异常，不抵抗恶意行为的节点，或者说使用不同协议的参与者，或者说参与者不能撒谎，所以经典的 Paxos 不抵抗拜占庭问题（也有针对拜占庭问题的 Paxos 带了 verify 的过程）。</p>
<p>Paxos 论文里面描述的算法，其实不是很清晰，一般人看了都会有疑问，所以后来很多人对这个算法做了补充和解释，包括作者本人。</p>
<h2 id="基本需求"><a href="#基本需求" class="headerlink" title="基本需求"></a>基本需求</h2><p>第一个是安全性，就是只有一个值会被选择，并且节点对这个值不会主动知道，而是在值被选择以后被动学习知道这个值被选择的（这个原文有点难懂我换成了自己的话解释了一下）。<br>第二个是活性，也就是值最终会被选择，并且所有节点会最终学习到这个值被选择了。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>首先单点可以排除，因为单点虽然是最容易解决一致性问题的，但是如果单点挂了，整个就不可用了，所以显然不能依靠单点。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/quorum-base.png" class="" title="[single point]">

<p>那如果每个节点就接受自己接受到的第一个值，也会有平票问题(split votes)。<code>red</code> 和 <code>blue</code> 对等的，那到底谁被选择了呢，所以来了就接受的策略并不可行。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/split-votes.png" class="" title="[split votes]">

<p>Paxos 是 quorum based 的，表示的一致性协议是少数服从多数的，在大多数节点都接受了这个值以后，这个值就被选择了。为了让节点可以接受多个值，多个值之间需要区分，所以就有了提交号，这个号码是单增的，拒绝掉小号的提交，并且当一个值已经被选择，那么之后的提交都要提交这个值，这样做的目的是让提交者知道这个值被学习了，是大家认可的一个值。有了少数服从多数原则，就会碰到冲突的问题。</p>
<p>这种情况就是下面这样，从时间上来讲，<code>red</code> 已经被选择了，如果 <code>S3</code> 能够拒绝 <code>red</code> 的提交，那么 <code>S3</code>,<code>S4</code>,<code>S5</code>就可以拿着 <code>red</code> 重试，并且知道 <code>red</code> 已经被大多数人接受了，而知道冲突的 <code>S3</code> 就会决绝这次请求，这个点上就处理了两个值（接受了一个拒绝了一个）。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/conflict.png" class="" title="[conflict 1]">

<p>序列号可以帮助我们区分优先关系，这样因为网络问题延迟的请求就可以被处理。下面这种情况，<code>red</code> 虽然先提交，但是并不是先被大多数接受的（存在网络延迟），这个时候<code>blue</code>已经被选择了（被大多数人接受），我们需要提交 <code>red</code> 的提交意识到自己已经太“老”了，而触发这就是接受了 <code>blue</code> 的 <code>S3</code>。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/conflict-1.png" class="" title="[conflict 2]">

<p>所以你会发现，矛盾的点其实就是这个 S3，也就是少数服从多数原则，能保证任意的大多数都是有交集的。交集中的点会发现矛盾和之前接受的值有矛盾选择拒绝。</p>
<blockquote>
<p>问题：三节点的容忍度是 1，四节点的容忍度是多少？</p>
<p>答案：也是 1，因为要形成发现矛盾的交集对于 4 来说，要达到 3/4，才能构成大多数，这就是为什么集群选单数的原因，因为双数从算法的角度来说没什么帮助。</p>
</blockquote>
<p>接下来看具体的算法。</p>
<p>其实，从朴素角度来说，经典 Paxos 看起来就是一个两阶段提交的过程，首先是准备阶段，选择一个提交号 n，提交 prepare(n)，接受者需要返回自己接受的值，和已经接受的提交号。当从大多数收到回复以后就可以做判断了，如果有返回接受值，选择提交号最大的值进行下一阶段（这个行为对应的是发现有值可能被接受了，尝试服从或者学习这个接受），不然就可以用自己的值进行下一阶段。</p>
<p>下一阶段就是 accept(value,n)，如果接受者发现自己目前收到的n，没有比accpet给的n大，就接受这个值，并且更新自己的n，否则就拒绝（这里就保证提交者能够发现自己变老了或者被拒绝了）。<br>如果接受者发现提交号大于自己当前的最大提交号，就接受这个值，不然就拒绝。当提交者从大多数人那里接受到返回以后发现有拒绝的情况，就进行重试拿一个新的n开始，否则这个值就被接受了。</p>
<p>Basic Paxos value 就是设置一次，不存在再设次一次的情况。</p>
<p>总结起来就是如图：</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/basic-paxos.png" class="" title="[basic paxos]">

<p>那这样的一个二阶段提交，看看能不能解决前面的问题，主要有三种可能。<br>注意，这里的例子是原文里的例子，一个变量的取值是<code>X</code>或者<code>Y</code>，然后<code>3.1</code> 表示 <code>S1</code>提交的提交号为 <code>3</code> 的提交，这是我们定义的 message ID。</p>
<p>第一种值被选择了，后者意识到了<code>X</code>，放弃<code> Y</code> 用 <code>X </code>提交，也就意味着提交者学习到了这个值已经被选择了。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/paxos-p1.png" class="" title="[situation 1]">

<p>第二种情况，值没有被选择，但是交集的部分看到了一个被选择的值，也会选择放弃<code>Y</code>用<code>X</code>提交，虽然<code>X</code>暂时没有被选择（被大多数人接受），但是可以保证两个提交都成功。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/paxos-conflict-2.png" class="" title="[situation 2]">

<p>第三种情况，值没有被选择，同时交集的部分也没有发现被选择的值，如果已经做了 promies 这个时候就会拒绝老的提交。比如下面在 S3 accept(X) 的时候就会放弃提交并且进行重试(S1 S2 也会一起重试）, 并且在重试的时候覆盖掉原先接受的x)。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/paxos-conflict3.png" class="" title="[situation 3]">

<p>看起来所有的问题都解决了，但是活性问题无法保证。这个情况发生在提交之间相互阻塞的情况，<code>S3</code> <code>S4</code> <code>S5</code> 拿着更高的提交号导致 <code>S1</code> <code>S2</code> <code>S3</code> 的 accept 被拒绝重新进行提交，又把 <code>S3</code> <code>S4</code> <code>S5</code> 给拒绝了。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/paxos-liveness.png" class="" title="[liveness]">

<p>解决这个问题的办法就是把重试时间进行一些随机化，减少这种巧合发生，或者把重试的时间指数增长等等。</p>
<h2 id="Multi-Paxos"><a href="#Multi-Paxos" class="headerlink" title="Multi-Paxos"></a>Multi-Paxos</h2><p>到此 classic Paxos 算是告一段落。那 Paxos 有什么问题呢。首先是活性的问题，这个在后面可以通过选主的方式解决。其次是学习是通过 propose 获知值的，不然无法知道一个值是否被接受了，要走一遍整套的 Paxos 协议。</p>
<p>Multi-Paxos 新增的问题是如何选择 log entry，并且用选主的方式减少冲突，以及减少 prepare 的请求。</p>
<p>以下图为例。深色框表示这个 log 已经被选择（怎么确定选择后面会提到）。寻找 log entry 的方式就是寻找第一个没有被选择的 log，尝试执行 basic Paxos，如果有值被选择会尝试用这个 log 提交帮助这个 log 被选择，这个过程和 basic paxos 是一致的，但是在此之后就要继续寻找下一个 log 尝试进行我们的尝试。</p>
<p>下图中（只看 S1 和 S2 这两行），第一次会找到最后一个没有没学习的 log，也就是 index=3 的 log，但是发现了 <code>s1</code> 的 <code>cmp</code>，就会服从这个 <code>cmp</code>，然后到 <code>index=4</code> 发现了 <code>s2</code> 的 <code>sub</code>，也选择服从，并且学习到了 index=4 的 log 应该是 <code>sub</code>，最后到了 index=5 才进行插入。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/multi-paxos-log.png" class="" title="[multi-paxos]">

<p>这样的情况下，Paxos 可以接受并发的请求，而 Raft 却规定了对 log 只能 append，不能 3 4 5 都能同时处理，简化了实现。反正只要保证了 log 的顺序一致，状态机的最终状态都是一致的。 </p>
<p>接下来的是对于性能的一些提升，一个是选主避免大面积冲突，另一个是优化二阶段提交的次数。解决方法是选出一个主，保证一次只有一个提交者。另外对于 prepare 是对整个 log 进行 prepare，而不是单个 log entry，这样大多数情况下，大部分 log 都可以一次性就被选择。</p>
<p>可以通过 lease based 选主。 lamport 提出的方式比较简单，节点之间维持T间隔的心跳，2T 之内没有收到更高编号的主的心跳就成为主，非主则转发请求给主，这样还是不会避免同时出现两主的情况，两主会有冲突，但 Paxos 就算有两主还是能正常运行，毕竟有主只是优化方式。</p>
<p>接下来我们看看优化提交的过程。回忆一下，prepare 的作用，其中一点是帮助我们发现冲突，知道有值可能被选择了，另外一点是拒绝老的提交，让他们发现自己变“老”了。</p>
<p>我们可以改变提交号的意义，让他代表整个 log，也就是所有 log entry 都用一个提交号，这样接受者可以通过返回 <code>noMoreAccepted</code> 让提交者意识到在当前 log entry 之后的 log 都没有 accpeted 是可以被“锁”住的，然后如果大多数节点返回 <code>noMoreAccepted</code>，就可以跳过之后的 prepare 直到 accept 被拒绝。这样后续的 accept 操作就可以不用 prepare 在一趟之内解决，所以二阶段提交的第一阶段的 promise 落在了整个 log 上。这个情况下 发起者的 accept 一直顺序进行就可以，问题发生在有其他主（之前说到的会临时有多主的情况），又提交了 prepare，然后这个提交号更高，把后一段锁住了，accept 就会发现冲突学习新的值。</p>
<p>补充 1 持续发送 accept 请求，让所有的节点都同步这个 log。<br>补充 2 让 proposer 带上 firstUnchosenIndex 让 acceptor 知道大多数可以确认被选择的 log。</p>
<p>但是还有问题，例如下面这张图，对于所有小于 firstUnchosenIndex 的 i 来说，如果 accpetedProposal[i] 的提交号和 request 的 proposal 一样的话，就可以确认 log[i] 是被选择了的，并且标记 acceptedProposal[i] = 无限。但是 2.5 确实来自之前的 leader 的，貌似无法被标记为选择了。这需要我们进一步修改这个协议。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/multi-paxos-index.png" class="" title="[multi paxos index]">

<p>这个时候需要在 accept 返回的时候带上自己的 firtUnchosenIndex，如果 proposer 的比这个大，可以把 acceptor 直接补齐。用 success 命令，让 acceptor 直接更改index 的这个值, 并且继续返回 firtUnchosenIndex，让 proposer 弥补。</p>
<p>最后一部分是配置改变，degree of replication，也就是要保证同时只有一个 conf 生效，可以用 a 个之前的 log 做 conf，这样在使用这个 conf 之前，conf 已经发生了改变。但是同时限制住了并发度（只能为a）。直觉上讲就是约定一个 index 在某个时间点一次性切换。</p>
<img data-src="/zh-CN/2018/05/20/paxos-%E6%80%BB%E7%BB%93/multi-paxos-conf.png" class="" title="[multi paxos conf]">

<p>参考文献</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ramcloud.stanford.edu/~ongaro/userstudy/paxos.pdf">paxos</a></li>
<li><a target="_blank" rel="noopener" href="https://understandingpaxos.wordpress.com/">understandingpaxos</a></li>
<li><a target="_blank" rel="noopener" href="http://wordpress.redirectingat.com/?id=725X1342&site=understandingpaxos.wordpress.com&xs=1&isjs=1&url=http://research.microsoft.com/en-us/um/people/lamport/pubs/paxos-simple.pdf&xguid=adcd021eccdd496512b31b2a9644cf70&xuuid=ec594abaa6f4be12a55f12e9582e8703&xsessid=a52733cdf2efc0765e23e0dac5822fd0&xcreo=0&xed=0&sref=https://understandingpaxos.wordpress.com/&pref=https://understandingpaxos.wordpress.com/&xtz=-480&jv=13.4.0&bv=2.5.1">Paxos made simple</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ggaaooppeenngg.github.io/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ggaaooppeenngg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ggaaooppeenngg">
      <meta itemprop="description" content="为什么计算机科学是无限的但生命是有限的">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ggaaooppeenngg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/" class="post-title-link" itemprop="url">k8s 基于 kubeadm 的安全配置和高可用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-04-30 16:03:08" itemprop="dateCreated datePublished" datetime="2018-04-30T16:03:08+08:00">2018-04-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-28 18:39:05" itemprop="dateModified" datetime="2025-03-28T18:39:05+08:00">2025-03-28</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="zh-CN/2018/04/30/k8s-基于-kubeadm-的安全配置和高可用/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最新的 kubeadm 的设计文档在<a target="_blank" rel="noopener" href="https://github.com/kubernetes/website/blob/master/docs/reference/setup-tools/kubeadm/kubeadm.md">这里</a>，如果把里面设计大概看一遍就能够理解里面的流程了，可以说设计的还是很缜密的，并且大大简化了 k8s 的运维工作。</p>
<h2 id="kubeadm-安全设施"><a href="#kubeadm-安全设施" class="headerlink" title="kubeadm 安全设施"></a>kubeadm 安全设施</h2><p>主要解释 kubeadm init 和 kubeadm join 的过程和实现</p>
<h3 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h3><ol>
<li>首先进行 preflight-checks ，检查系统是否满足初始化的状态。</li>
<li>创建自签名的 CA，并且生成和签发各个 component 的私钥和证书 (/etc/kubernetes/pki)，如果文件已存在就不会再生成了，比如要给 apiserver 添加域名可以重新签发一个证书，然后重启就好了。</li>
<li>写入各个服务的配置文件，以及一个 admin.conf (/etc/kubernetes/)</li>
<li>配置 kubelet 的动态配置加载     (disable by default)</li>
<li>配置静态 pod  (/etc/kubernetes/manifests)</li>
<li>给 master 添加 taint 和 label，让其他 pod 默认不会运行在 master 上</li>
<li>生成用于让其他 kubelet 加入的 token</li>
<li>配置用 token 加入的可以自动确认 CSR（也就是用 CA 自动签 kubelet 的证书）</li>
<li>设置 kube-dns</li>
<li>检查 self-hosting，如果设置了，就把 static pod 转成 daemonset</li>
</ol>
<p>是否使用外部 CA 的条件是，目录下有 CA 证书，但是没有 CA 私钥。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> res, _ := certsphase.UsingExternalCA(i.cfg); !res &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PHASE 1: Generate certificates</span></span><br><span class="line">        <span class="keyword">if</span> err := certsphase.CreatePKIAssets(i.cfg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PHASE 2: Generate kubeconfig files for the admin and the kubelet</span></span><br><span class="line">        <span class="keyword">if</span> err := kubeconfigphase.CreateInitKubeConfigFiles(kubeConfigDir, i.cfg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;[externalca] The file &#x27;ca.key&#x27; was not found, yet all other certificates are present. Using external CA mode - certificates or kubeconfig will not be generated.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的生成 PKI 相关的配置的过程</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreatePKIAssets will create and write to disk all PKI assets necessary to establish the control plane.</span></span><br><span class="line"><span class="comment">// If the PKI assets already exists in the target folder, they are used only if evaluated equal; otherwise an error is returned.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreatePKIAssets</span><span class="params">(cfg *kubeadmapi.MasterConfiguration)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">        certActions := []<span class="function"><span class="keyword">func</span><span class="params">(cfg *kubeadmapi.MasterConfiguration)</span></span> <span class="type">error</span>&#123;</span><br><span class="line">                CreateCACertAndKeyFiles,</span><br><span class="line">                CreateAPIServerCertAndKeyFiles,</span><br><span class="line">                CreateAPIServerKubeletClientCertAndKeyFiles,</span><br><span class="line">                CreateEtcdCACertAndKeyFiles,</span><br><span class="line">                CreateEtcdServerCertAndKeyFiles,</span><br><span class="line">                CreateEtcdPeerCertAndKeyFiles,</span><br><span class="line">                CreateEtcdHealthcheckClientCertAndKeyFiles,</span><br><span class="line">                CreateAPIServerEtcdClientCertAndKeyFiles,</span><br><span class="line">                CreateServiceAccountKeyAndPublicKeyFiles,</span><br><span class="line">                CreateFrontProxyCACertAndKeyFiles,</span><br><span class="line">                CreateFrontProxyClientCertAndKeyFiles,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, action := <span class="keyword">range</span> certActions &#123;</span><br><span class="line">                err := action(cfg)</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> err</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">&quot;[certificates] Valid certificates and keys now exist in %q\n&quot;</span>, cfg.CertificatesDir)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>列表中的函数都是用来生成所有证书和私钥的，主要依靠 <code>k8s.io/kubernetes/cmd/kubeadm/app/phases/certs/pkiutil </code> 来完成。私钥很容易生成，没什么需要特别配置的，主要看 CA 的证书里面配了啥，因为这个跟 k8s 的鉴权有关系。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewSelfSignedCACert creates a CA certificate</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSelfSignedCACert</span><span class="params">(cfg Config, key *rsa.PrivateKey)</span></span> (*x509.Certificate, <span class="type">error</span>) &#123;</span><br><span class="line">        now := time.Now()</span><br><span class="line">        tmpl := x509.Certificate&#123;</span><br><span class="line">                SerialNumber: <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">0</span>),</span><br><span class="line">                Subject: pkix.Name&#123;</span><br><span class="line">                        CommonName:   cfg.CommonName,</span><br><span class="line">                        Organization: cfg.Organization,</span><br><span class="line">                &#125;,</span><br><span class="line">                NotBefore:             now.UTC(),</span><br><span class="line">                NotAfter:              now.Add(duration365d * <span class="number">10</span>).UTC(),</span><br><span class="line">                KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,</span><br><span class="line">                BasicConstraintsValid: <span class="literal">true</span>,</span><br><span class="line">                IsCA: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        certDERBytes, err := x509.CreateCertificate(cryptorand.Reader, &amp;tmpl, &amp;tmpl, key.Public(), key)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x509.ParseCertificate(certDERBytes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 <code>openssl x509 -in /etc/kubernetes/pki/ca.crt -text -noout</code> 可以查看 ca 证书里面的内容，和我们看到的配置是一致的。</p>
<img data-src="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/ca-pic.png" class="" title="[ca]">

<p>然后我们再看一下 apiserver 的私钥和证书是怎么签的，首先把生成的 CA 证书和私钥加载进来，然后生成私钥并且签出自己的证书。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateAPIServerCertAndKeyFiles</span><span class="params">(cfg *kubeadmapi.MasterConfiguration)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">        caCert, caKey, err := loadCertificateAuthority(cfg.CertificatesDir, kubeadmconstants.CACertAndKeyBaseName)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        apiCert, apiKey, err := NewAPIServerCertAndKey(cfg, caCert, caKey)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> writeCertificateFilesIfNotExist(</span><br><span class="line">                cfg.CertificatesDir,</span><br><span class="line">                kubeadmconstants.APIServerCertAndKeyBaseName,</span><br><span class="line">                caCert,</span><br><span class="line">                apiCert,</span><br><span class="line">                apiKey,</span><br><span class="line">        )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里比较重要，因为 SAN 这个是用来匹配域名的，如果这里没写好，HTTPS 是拒绝访问的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewAPIServerCertAndKey generate certificate for apiserver, signed by the given CA.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPIServerCertAndKey</span><span class="params">(cfg *kubeadmapi.MasterConfiguration, caCert *x509.Certificate, caKey *rsa.PrivateKey)</span></span> (*x509.Certificate, *rsa.PrivateKey, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">        altNames, err := pkiutil.GetAPIServerAltNames(cfg)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failure while composing altnames for API server: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        config := certutil.Config&#123;</span><br><span class="line">                CommonName: kubeadmconstants.APIServerCertCommonName,</span><br><span class="line">                AltNames:   *altNames,</span><br><span class="line">                Usages:     []x509.ExtKeyUsage&#123;x509.ExtKeyUsageServerAuth&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">        apiCert, apiKey, err := pkiutil.NewCertAndKey(caCert, caKey, config)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failure while creating API server key and certificate: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> apiCert, apiKey, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img data-src="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/api-crt.png" class="" title="[apiserver crt]">

<p>apiserver 的证书也是对的，马赛克的部分是我自己配的一些 IP 和 域名，和 kubeadm 配的一些 kube-dns 用的 overlay 网络上的 master 域名，其他 master 上的 components 也是类似的，在配高可用的时候要把每个 master 节点上的域名和 IP 都配上。kubelet 的证书也要配对，就在 join 里面介绍了，这个会用来鉴权 node 的身份。</p>
<p>其他部分的代码和设计文档的描述是一致的，所以没什么好看的，感觉一个好的设计文档是非常重要的，代码只是设计的实现，如果设计本身就可读性很强，阅读代码只是辅助理解一些细节和找 BUG 用的而已。</p>
<h3 id="kubeadm-join"><a href="#kubeadm-join" class="headerlink" title="kubeadm join"></a>kubeadm join</h3><ol>
<li>首先用 token 鉴权的方式获取 apiserver 的 CA 证书，并且通过 SHA256 验证。</li>
<li>加载动态配置，如果 master 上有的话。</li>
<li>TLS 初始化，首先用 token 鉴权的方式把自己的 CSR 发给 apiserver，然后签发自己的证书，这个证书要用来检查 node 的身份的。</li>
<li>配置 kubelet 和 server 开始建立连接。</li>
</ol>
<p>新版本的 kubelet 有些变动，支持把一些 featuregate 配置写到文件里面，比如这个<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/43783">阻止 fork bomb</a> 的配置，新版本只能用配置文件写了，不能通过参数配置。</p>
<p>kubeadm 的详细过程如下：</p>
<p>首先会把 flags 传入<code> NodeConfiguration</code> 中，开始 <code>AddJoinConfigFlags(cmd.PersistentFlags()</code>，如果没有 <code>nodeNamecfg</code> 默认用 host 的 name 并且小写化通过 <code>GetHostname</code>获得，和在宿主机上执行 <code>hostname</code> 是一致的。在初始化之前先 尝试启动 <code>TryStartKubelet</code> 过程，然后把 token 和 server 写入（证书 data 是怎么生成的？），先配置kubelet-bootstrap-config</p>
<p> 整体流程如下，token 验证是基于 JWT 的，所以 token 的格式是 <code>&quot;^([a-z0-9]&#123;6&#125;)\\.([a-z0-9]&#123;16&#125;)$&quot;</code>，分两部分，<code>tokenID.tokenSecret</code>，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">discovery.For</span><br><span class="line">-&gt;GetValidatedClusterInfoObject 这个是获取 CA 证书的过程</span><br><span class="line">     -&gt;token.RetrieveValidatedClusterInfo 这一步是 JWT 验证</span><br><span class="line">         -&gt;tokenutil.ParseToken   得到 tokenID 和 tokenSecret</span><br><span class="line">         -&gt;pubKeyPins.Allow 加载用于检验 CA 证书的 HASH 值</span><br><span class="line">         -&gt;buildInsecureBootstrapKubeConfig （用 token-bootstrap-client 身份)获取信息</span><br><span class="line">            -&gt; 从kube-public 获取 configmap (和 kubectl describe configmap cluster-info -n kube-public 中的信息是一致的）这个configmap 里面包含 JWS 签名和 master 的 CA 证书，获取对应 tokenID 的 jws token，验证 token 成功，并且验证 CA 的证书 hash，如果通过说明这个 master 是可信的，然后拿到 CA 证书以后开始构建自己的证书，建立 secure config。</span><br><span class="line">         -&gt;</span><br></pre></td></tr></table></figure>

<p>kubeconfigutil.WriteToDisk 会把 <code>bootstrap-kubelet.conf</code> 写入到配置目录中，kubeadm 的任务就完成了，之前的 kubeadm 会代替 kubelet 生成 kubelet.conf（其中用的是公钥鉴权），现在移走了，kubelet 启动的时候会尝试使用这个配置文件建立 HTTPS 的鉴权配置文件。</p>
<img data-src="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/bootstrap-conf.png" class="" title="[boostrap conf]">

<p>可以看一下 kubelet 用这个配置给 master 发 CSR 以后得到了什么，可以看到是生成了自己的证书的。</p>
<img data-src="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/kubelet-crt.png" class="" title="[kubelet bootstrap conf]">

<p>并且这个证书里面的 SAN 也是用来进行 Node 鉴权的身份确认的信息。用 <code>openssl x509 -in /var/lib/kubelet/pki/kubelet-client.crt  -text -noout</code>查看信息。</p>
<img data-src="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/kubelet-https-crt.png" class="" title="[kubelet conf]">

<p>红线部分就是 Node 鉴权的信息，基于这个确认 node 的身份。另外一个是 Role Based Access Control，那个主要是配给 pod，限制 pod 行为用的，类似于 linux 的 <code>chmod</code>。</p>
<h2 id="kubeadm-高可用配置"><a href="#kubeadm-高可用配置" class="headerlink" title="kubeadm 高可用配置"></a>kubeadm 高可用配置</h2><p>如果没有安全配置，其实高可用挺好配置的，现在加入了安全配置，虽然麻烦，但是还是能理解 k8s 的良苦用心的，理解了整个鉴权的过程以后就可以做，现在支持配置文件初始化其实更好配置了。可以基于<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/independent/high-availability/">这个文档配置</a>，算了我还是不总结了，看懂上面的，照着配置就好了。主要是自己生成 CA，他们用的 <code>cfssl</code> 和 <code>cfssljson</code>，这个工具比 openssl 好用一点，比较容易配置。生成 ca 证书和私钥以后，就可以构建 HTTPS 的 etcd。</p>
<p>先创建 ca 的配置文件 <code>ca-config.json</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;signing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;43800h&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;profiles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;43800h&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;usages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;signing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;server auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;client auth&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;client&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;43800h&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;usages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;signing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;client auth&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;peer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;expiry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;43800h&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;usages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;signing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;key encipherment&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;server auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;client auth&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后生成用于自签名的 csr 的配置文件 <code>ca-csr.json</code>，用于签发自签名的 CA 证书。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;etcd&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果就是目录下面生成了，<code>ca-key.pem</code> 和 <code>ca.pem</code>，这个命令不太按规则，对应的叫 <code>ca.key</code> 和 <code>ca.crt</code>，<code>pem</code> 是密钥保存的格式。</p>
<p>接下来用 <code>client.json</code> 获得自己的私钥和通过 ca 签的证书。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;client&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ecdsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client.json | cfssljson -bare client</code>，生成了 <code>client-key.pem</code>,<code>client.pem</code>，分别是私钥和证书，把文件 <code>ca.pem</code>,<code>ca-key.pem</code>, <code>client.pem</code>,<code>client-key.pem</code>,<code>ca-config.json</code>, 拷贝到每台 master 机器上面，一般放到 <code>/etc/kubernetes/pki/</code> 下面。</p>
<p>然后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr &gt; config.json</span><br><span class="line">sed -i &#x27;0,/CN/&#123;s/example\.net/&#x27;&quot;$PEER_NAME&quot;&#x27;/&#125;&#x27; config.json</span><br><span class="line">sed -i &#x27;s/www\.example\.net/&#x27;&quot;$PRIVATE_IP&quot;&#x27;/&#x27; config.json</span><br><span class="line">sed -i &#x27;s/example\.net/&#x27;&quot;$PEER_NAME&quot;&#x27;/&#x27; config.json</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server config.json | cfssljson -bare server</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer config.json | cfssljson -bare peer</span><br></pre></td></tr></table></figure>

<p>签出出两对密钥和证书，把每台的机器的 域名 和 IP 替换掉示例的 example 配置，就是这些地方可以改成自己的域名和地址，这个会被用来 check。</p>
<img data-src="/zh-CN/2018/04/30/k8s-%E5%9F%BA%E4%BA%8E-kubeadm-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/etcd-csr.png" class="" title="[etcd csr ]">

<p>可以放到 kubelet 的 static pod 里面，启动 etcd，两个证书分别是用作 server 验证和 client 验证的，server 让别人访问的时候相信你，peer 是你访问别人的时候让别人相信你。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;/etc/kubernetes/manifests/etcd.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">etcd</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&lt;podname&gt;</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd</span> <span class="string">--name</span> <span class="string">$&#123;PEER_NAME&#125;</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--data-dir</span> <span class="string">/var/lib/etcd</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--listen-client-urls</span> <span class="string">https://$&#123;PRIVATE_IP&#125;:2379</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-client-urls</span> <span class="string">https://$&#123;PRIVATE_IP&#125;:2379</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--listen-peer-urls</span> <span class="string">https://$&#123;PRIVATE_IP&#125;:2380</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--initial-advertise-peer-urls</span> <span class="string">https://$&#123;PRIVATE_IP&#125;:2380</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--cert-file=/certs/server.pem</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--key-file=/certs/server-key.pem</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-cert-auth</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--trusted-ca-file=/certs/ca.pem</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-cert-file=/certs/peer.pem</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-key-file=/certs/peer-key.pem</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-client-cert-auth</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-trusted-ca-file=/certs/ca.pem</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--initial-cluster</span> <span class="string">etcd0=https://&lt;etcd0-ip-address&gt;:2380,etcd1=https://&lt;etcd1-ip-address&gt;:2380,etcd2=https://&lt;etcd2-ip-address&gt;:2380</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--initial-cluster-token</span> <span class="string">my-etcd-token</span> <span class="string">\</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--initial-cluster-state</span> <span class="string">new</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/etcd-amd64:3.1.10</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">    <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">2379</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PUBLIC_IP</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PRIVATE_IP</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PEER_NAME</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">certs</span></span><br><span class="line"><span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki/etcd</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">certs</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>然后每个节点的 master init 的配置文件按照下面这个配置，client.pem 是用来让 etcd 相信 apiserver 的。<code>private-ip</code> 和 <code>load-balancer-ip</code> 都是要写到证书的  SAN 里面的，不然用这些 ip 是访问不了 apiserver 的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MasterConfiguration</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="string">&lt;private-ip&gt;</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">https://&lt;etcd0-ip-address&gt;:2379</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">https://&lt;etcd1-ip-address&gt;:2379</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">https://&lt;etcd2-ip-address&gt;:2379</span></span><br><span class="line">  <span class="attr">caFile:</span> <span class="string">/etc/kubernetes/pki/etcd/ca.pem</span></span><br><span class="line">  <span class="attr">certFile:</span> <span class="string">/etc/kubernetes/pki/etcd/client.pem</span></span><br><span class="line">  <span class="attr">keyFile:</span> <span class="string">/etc/kubernetes/pki/etcd/client-key.pem</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="string">&lt;podCIDR&gt;</span></span><br><span class="line"><span class="attr">apiServerCertSANs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&lt;load-balancer-ip&gt;</span></span><br><span class="line"><span class="attr">apiServerExtraArgs:</span></span><br><span class="line">  <span class="attr">apiserver-count:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>至于怎么做 loadbalance 可以用七层的也可以用四层的，七层把证书配到负载均衡服务上，四层的就不用，自己在裸机器上做可以用 vip + nginx 做一个四层的，也可以把证书放到 nginx 上做七层的，但是在云环境下，都不怎么支持自己配置 vip，需要用云厂商的 lb 服务，这个就看具体提供商的服务怎么配了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2014 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ggaaooppeenngg</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>



  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"ggaaooppeenngg","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
